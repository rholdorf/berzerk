---
phase: 06-room-system-progression
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Rooms/RoomManager.cs
autonomous: true

must_haves:
  truths:
    - "RoomManager holds current Room instance"
    - "RoomManager listens for all-enemies-defeated event"
    - "RoomManager opens doors when room is cleared"
    - "RoomManager detects player entering open door triggers"
    - "RoomManager fires room transition event for game to handle"
  artifacts:
    - path: "Berzerk/Source/Rooms/RoomManager.cs"
      provides: "Room lifecycle management and transition detection"
      contains: "class RoomManager"
      exports: ["OnRoomCleared", "OnRoomTransition"]
  key_links:
    - from: "Berzerk/Source/Rooms/RoomManager.cs"
      to: "Berzerk/Source/Rooms/Room.cs"
      via: "CurrentRoom property"
      pattern: "_currentRoom"
    - from: "Berzerk/Source/Rooms/RoomManager.cs"
      to: "Berzerk/Source/Enemies/EnemyManager.cs"
      via: "Event subscription pattern"
      pattern: "OnAllEnemiesDefeated"
---

<objective>
Create RoomManager to handle room lifecycle: tracking current room, listening for room clear events, opening doors, and detecting room transitions.

Purpose: Centralize room logic separate from Room data class. Manager pattern matches existing EnemyManager, TargetManager architecture.
Output: RoomManager class ready for BerzerkGame integration.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-room-system-progression/06-RESEARCH.md

Key patterns from research:
- Event-driven room clear detection (EnemyManager.OnAllEnemiesDefeated -> RoomManager.HandleRoomCleared)
- Room transition via trigger detection (check player vs open door triggers each frame)
- Short delay (0.5s) before opening doors after clear for visual clarity
- Clear projectiles on room transition (simpler than preserving across rooms)
- Spawn player 3 units inside room from entry door

Existing patterns from codebase:
- Manager classes (EnemyManager, TargetManager) follow Initialize/Update/Reset pattern
- Event-based wiring (EnemyHealth.OnDeath, HealthSystem.OnDamageTaken)
- Boolean state tracking (AllEnemiesDefeated property in EnemyManager)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoomManager with lifecycle management</name>
  <files>Berzerk/Source/Rooms/RoomManager.cs</files>
  <action>
Create RoomManager class that manages room state, door opening, and transition detection:

```csharp
using Microsoft.Xna.Framework;
using System;
using System.Collections.Generic;

namespace Berzerk.Source.Rooms;

/// <summary>
/// Manages room lifecycle: current room state, door opening on clear, and room transitions.
/// Wires to EnemyManager for room-clear detection.
/// </summary>
public class RoomManager
{
    private Room _currentRoom;
    private bool _roomCleared = false;
    private float _doorOpenDelay = 0f;
    private bool _doorsOpening = false;

    // Delay before doors open after room clear (for visual clarity)
    private const float DOOR_OPEN_DELAY = 0.5f;

    // Spawn offset from door (units inside room)
    private const float SPAWN_OFFSET_FROM_DOOR = 3f;

    /// <summary>
    /// Current room instance.
    /// </summary>
    public Room CurrentRoom => _currentRoom;

    /// <summary>
    /// Whether current room has been cleared of all enemies.
    /// </summary>
    public bool IsRoomCleared => _roomCleared;

    /// <summary>
    /// Event fired when room is cleared (all enemies defeated).
    /// </summary>
    public event Action OnRoomCleared;

    /// <summary>
    /// Event fired when player enters an open door.
    /// Provides exit direction for spawn position calculation.
    /// </summary>
    public event Action<Direction> OnRoomTransition;

    /// <summary>
    /// Initialize room manager with starting room.
    /// </summary>
    public void Initialize()
    {
        _currentRoom = new Room();
        _roomCleared = false;
        _doorsOpening = false;
        _doorOpenDelay = 0f;
    }

    /// <summary>
    /// Handle notification that all enemies in room are defeated.
    /// Call this from EnemyManager.OnAllEnemiesDefeated event.
    /// </summary>
    public void HandleAllEnemiesDefeated()
    {
        if (!_roomCleared)
        {
            _roomCleared = true;
            _doorsOpening = true;
            _doorOpenDelay = DOOR_OPEN_DELAY;
            Console.WriteLine("Room cleared! Doors opening in 0.5s...");
        }
    }

    /// <summary>
    /// Update room state, door animations, and check for player transition.
    /// </summary>
    public void Update(float deltaTime, Vector3 playerPos)
    {
        // Handle delayed door opening after room clear
        if (_doorsOpening)
        {
            _doorOpenDelay -= deltaTime;
            if (_doorOpenDelay <= 0)
            {
                _currentRoom.OpenAllDoors();
                _doorsOpening = false;
                OnRoomCleared?.Invoke();
                Console.WriteLine("Doors are now open!");
            }
        }

        // Update door animations
        _currentRoom.UpdateDoors(deltaTime);

        // Check for player entering open doors
        if (_roomCleared)
        {
            CheckDoorTransitions(playerPos);
        }
    }

    /// <summary>
    /// Check if player has entered any open door trigger volume.
    /// </summary>
    private void CheckDoorTransitions(Vector3 playerPos)
    {
        foreach (var kvp in _currentRoom.Doors)
        {
            Direction direction = kvp.Key;
            Door door = kvp.Value;

            if (door.CanPlayerEnter() && door.IsPlayerInTrigger(playerPos))
            {
                Console.WriteLine($"Player entered {direction} door! Transitioning...");
                OnRoomTransition?.Invoke(direction);
                break; // Only process one transition per frame
            }
        }
    }

    /// <summary>
    /// Perform room transition: reset doors, clear room state.
    /// Call this when handling OnRoomTransition event.
    /// </summary>
    public void TransitionToNewRoom()
    {
        // Close all doors for fresh challenge
        _currentRoom.CloseAllDoors();

        // Reset room state
        _roomCleared = false;
        _doorsOpening = false;
        _doorOpenDelay = 0f;

        Console.WriteLine("Room transitioned - fresh challenge begins!");
    }

    /// <summary>
    /// Calculate player spawn position based on entry direction.
    /// Exit North -> spawn at South door inside room, etc.
    /// </summary>
    public Vector3 GetSpawnPositionForEntry(Direction entryDirection)
    {
        // Entry direction is OPPOSITE of exit direction
        // If player exited North, they enter new room from South
        Direction entryDoor = GetOppositeDirection(entryDirection);

        if (_currentRoom.Doors.TryGetValue(entryDoor, out Door door))
        {
            // Spawn offset from door toward room center
            Vector3 offset = GetDirectionOffset(entryDoor) * SPAWN_OFFSET_FROM_DOOR;
            return door.Position + offset + new Vector3(0, 0.5f, 0); // Slight Y offset
        }

        // Fallback to room center
        return new Vector3(0, 0.5f, 0);
    }

    /// <summary>
    /// Get opposite cardinal direction.
    /// </summary>
    private Direction GetOppositeDirection(Direction direction)
    {
        return direction switch
        {
            Direction.North => Direction.South,
            Direction.South => Direction.North,
            Direction.East => Direction.West,
            Direction.West => Direction.East,
            _ => Direction.South
        };
    }

    /// <summary>
    /// Get Vector3 offset for direction (pointing INTO room).
    /// </summary>
    private Vector3 GetDirectionOffset(Direction direction)
    {
        return direction switch
        {
            Direction.North => new Vector3(0, 0, 1),   // North door, offset south into room
            Direction.South => new Vector3(0, 0, -1),  // South door, offset north into room
            Direction.East => new Vector3(-1, 0, 0),   // East door, offset west into room
            Direction.West => new Vector3(1, 0, 0),    // West door, offset east into room
            _ => Vector3.Zero
        };
    }

    /// <summary>
    /// Get current collision geometry (walls + closed doors).
    /// </summary>
    public List<BoundingBox> GetCollisionGeometry()
    {
        return _currentRoom.GetCollisionGeometry();
    }

    /// <summary>
    /// Get spawn points for enemy placement.
    /// </summary>
    public List<Vector3> GetEnemySpawnPoints()
    {
        return _currentRoom.EnemySpawnPoints;
    }

    /// <summary>
    /// Reset room manager (for game restart).
    /// </summary>
    public void Reset()
    {
        _currentRoom.CloseAllDoors();
        _roomCleared = false;
        _doorsOpening = false;
        _doorOpenDelay = 0f;
    }
}
```
  </action>
  <verify>File compiles without errors: `dotnet build Berzerk/Berzerk.csproj`</verify>
  <done>RoomManager has Initialize/Update/Reset pattern, HandleAllEnemiesDefeated for event wiring, door transition detection, spawn position calculation, and collision geometry accessor</done>
</task>

</tasks>

<verification>
All verification in single command:
```bash
dotnet build Berzerk/Berzerk.csproj && echo "BUILD SUCCESS - RoomManager compiles"
```

Expected: BUILD SUCCESS with no errors. RoomManager.cs exists in Berzerk/Source/Rooms/ with:
- OnRoomCleared event
- OnRoomTransition event (with Direction parameter)
- HandleAllEnemiesDefeated() method for EnemyManager wiring
- Update() that handles door delay and transition detection
- GetSpawnPositionForEntry() for player placement after transition
</verification>

<success_criteria>
1. RoomManager.cs created in Berzerk/Source/Rooms/
2. Project compiles without errors
3. RoomManager.Initialize() creates initial Room instance
4. RoomManager.HandleAllEnemiesDefeated() starts 0.5s delay then opens doors
5. RoomManager.Update() updates doors and checks for player in trigger volumes
6. OnRoomTransition event fires with Direction when player enters open door
7. GetSpawnPositionForEntry() returns position 3 units inside room from entry door
8. GetCollisionGeometry() delegates to current Room
</success_criteria>

<output>
After completion, create `.planning/phases/06-room-system-progression/06-02-SUMMARY.md`
</output>
