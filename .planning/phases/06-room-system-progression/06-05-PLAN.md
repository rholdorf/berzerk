---
phase: 06-room-system-progression
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Enemies/EnemyManager.cs
  - Berzerk/BerzerkGame.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Enemies spawn at room-defined spawn points instead of hardcoded safe zones"
    - "Room transition spawns enemies using Room.EnemySpawnPoints"
    - "Initial spawn and game restart both use room spawn points"
  artifacts:
    - path: "Berzerk/Source/Enemies/EnemyManager.cs"
      provides: "SpawnWave accepting List<Vector3> spawnPoints parameter"
      contains: "List<Vector3> spawnPoints"
    - path: "Berzerk/BerzerkGame.cs"
      provides: "All SpawnWave calls pass room spawn points"
      contains: "GetEnemySpawnPoints()"
  key_links:
    - from: "Berzerk/BerzerkGame.cs"
      to: "Berzerk/Source/Rooms/RoomManager.cs"
      via: "_roomManager.GetEnemySpawnPoints()"
      pattern: "GetEnemySpawnPoints"
    - from: "Berzerk/BerzerkGame.cs"
      to: "Berzerk/Source/Enemies/EnemyManager.cs"
      via: "SpawnWave with spawn points parameter"
      pattern: "SpawnWave.*GetEnemySpawnPoints"
---

<objective>
Wire room spawn points to enemy spawning, closing the gap where Room.EnemySpawnPoints (8 strategic positions) exist but are bypassed by EnemyManager's hardcoded _safeZones.

Purpose: Enemies should spawn at room-aware positions (corners and mid-wall zones) rather than Phase 5's hardcoded safe zones, completing ROOM-06 requirement.
Output: EnemyManager uses room-provided spawn points; hardcoded _safeZones removed.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@Berzerk/Source/Enemies/EnemyManager.cs
@Berzerk/Source/Rooms/Room.cs
@Berzerk/Source/Rooms/RoomManager.cs
@Berzerk/BerzerkGame.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spawn points parameter to EnemyManager.SpawnWave</name>
  <files>Berzerk/Source/Enemies/EnemyManager.cs</files>
  <action>
    Modify EnemyManager.SpawnWave to accept a List<Vector3> spawnPoints parameter:

    1. Change SpawnWave signature from `SpawnWave(int enemyCount, Vector3 playerPos)` to `SpawnWave(int enemyCount, Vector3 playerPos, List<Vector3> spawnPoints)`.

    2. Replace the spawn logic inside SpawnWave: instead of calling TryFindSpawnPosition (random) with fallback to _safeZones (hardcoded), iterate through provided spawnPoints. For each enemy to spawn, pick from spawnPoints using index modulo (i % spawnPoints.Count) to cycle through available points. Skip points too close to playerPos (reuse MIN_SPAWN_DISTANCE_FROM_PLAYER check). If a point is too close to player, try next point in list.

    3. Remove the hardcoded _safeZones field (lines 44-50), the ROOM_MIN/MAX constants (lines 37-41), and the TryFindSpawnPosition method (lines 152-185) since they are no longer needed. Keep MIN_SPAWN_DISTANCE_FROM_PLAYER and SPAWN_Y constants.

    4. Update StartNextWave to also accept spawnPoints and pass it through: `StartNextWave(Vector3 playerPos, List<Vector3> spawnPoints)`.

    Implementation detail for spawn selection:
    ```csharp
    public void SpawnWave(int enemyCount, Vector3 playerPos, List<Vector3> spawnPoints)
    {
        _allDefeatedFired = false;

        for (int i = 0; i < enemyCount; i++)
        {
            // Cycle through spawn points, skipping those too close to player
            Vector3 spawnPos = Vector3.Zero;
            bool found = false;

            for (int j = 0; j < spawnPoints.Count; j++)
            {
                int idx = (i + j) % spawnPoints.Count;
                Vector3 candidate = spawnPoints[idx];

                if (Vector3.Distance(candidate, playerPos) >= MIN_SPAWN_DISTANCE_FROM_PLAYER)
                {
                    spawnPos = candidate;
                    found = true;
                    break;
                }
            }

            if (!found && spawnPoints.Count > 0)
            {
                // All points too close to player, use the one furthest away
                float maxDist = 0;
                foreach (var pt in spawnPoints)
                {
                    float dist = Vector3.Distance(pt, playerPos);
                    if (dist > maxDist)
                    {
                        maxDist = dist;
                        spawnPos = pt;
                    }
                }
                found = true;
            }

            if (found)
            {
                SpawnEnemy(spawnPos);
            }
        }
    }
    ```
  </action>
  <verify>
    Build succeeds: `dotnet build Berzerk/Berzerk.csproj` compiles without errors.
    Grep confirms: no references to _safeZones remain, SpawnWave has List<Vector3> parameter.
  </verify>
  <done>
    EnemyManager.SpawnWave accepts room-provided spawn points. Hardcoded _safeZones and random spawn logic removed. StartNextWave passes through spawn points.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire room spawn points in BerzerkGame</name>
  <files>Berzerk/BerzerkGame.cs</files>
  <action>
    Update all SpawnWave call sites in BerzerkGame to pass room spawn points:

    1. In LoadContent (line 174, initial spawn):
       Change: `_enemyManager.SpawnWave(3, _playerController.Transform.Position);`
       To: `_enemyManager.SpawnWave(3, _playerController.Transform.Position, _roomManager.GetEnemySpawnPoints());`

    2. In the G key test spawn (line 279):
       Change: `_enemyManager.SpawnWave(waveSize, _playerController.Transform.Position);`
       To: `_enemyManager.SpawnWave(waveSize, _playerController.Transform.Position, _roomManager.GetEnemySpawnPoints());`

    3. In RestartGame (line 376):
       Change: `_enemyManager.SpawnWave(3, _playerController.Transform.Position);`
       To: `_enemyManager.SpawnWave(3, _playerController.Transform.Position, _roomManager.GetEnemySpawnPoints());`

    4. In HandleRoomTransition (line 402):
       Change: `_enemyManager.SpawnWave(enemyCount, _playerController.Transform.Position);`
       To: `_enemyManager.SpawnWave(enemyCount, _playerController.Transform.Position, _roomManager.GetEnemySpawnPoints());`
  </action>
  <verify>
    Build succeeds: `dotnet build Berzerk/Berzerk.csproj` compiles without errors.
    Grep confirms: all SpawnWave calls include GetEnemySpawnPoints().
    Grep confirms: no SpawnWave calls remain with only 2 arguments.
  </verify>
  <done>
    All 4 SpawnWave call sites in BerzerkGame pass room spawn points from RoomManager. The Room -> RoomManager -> BerzerkGame -> EnemyManager spawn point pipeline is fully wired.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/Berzerk.csproj` compiles cleanly
2. `grep -rn "_safeZones" Berzerk/` returns no results (hardcoded zones removed)
3. `grep -rn "GetEnemySpawnPoints" Berzerk/` shows RoomManager definition + 4 BerzerkGame call sites
4. `grep -rn "SpawnWave" Berzerk/` shows all calls include 3 parameters (count, playerPos, spawnPoints)
5. `grep -rn "TryFindSpawnPosition" Berzerk/` returns no results (random spawn removed)
</verification>

<success_criteria>
- EnemyManager.SpawnWave accepts List<Vector3> spawnPoints from room system
- All 4 SpawnWave calls in BerzerkGame pass _roomManager.GetEnemySpawnPoints()
- Hardcoded _safeZones array removed from EnemyManager
- TryFindSpawnPosition random logic removed from EnemyManager
- Project builds without errors
- Room.EnemySpawnPoints -> RoomManager.GetEnemySpawnPoints() -> BerzerkGame -> EnemyManager.SpawnWave pipeline complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-room-system-progression/06-05-SUMMARY.md`
</output>
