---
phase: 02-content-pipeline-processor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk.ContentPipeline/MixamoModelProcessor.cs
  - Berzerk.ContentPipeline/AnimationData.cs
  - Berzerk.ContentPipeline/AnimationClip.cs
  - Berzerk.ContentPipeline/Keyframe.cs
  - Berzerk.ContentPipeline/AnimationDataWriter.cs
autonomous: true

must_haves:
  truths:
    - "MixamoModelProcessor.Process() uses MeshHelper.FlattenSkeleton() for canonical bone ordering"
    - "Bind pose and inverse bind pose are extracted from the flattened skeleton"
    - "Animation keyframes use bone indices from the flattened skeleton, not custom depth-first traversal"
    - "SkinnedEffect is forced via DefaultEffect property override"
    - "SkinningData is attached to Model.Tag after base.Process()"
    - "Old pipeline-side AnimationData types are deleted and project compiles without them"
  artifacts:
    - path: "Berzerk.ContentPipeline/MixamoModelProcessor.cs"
      provides: "Content Pipeline processor producing SkinningData from Mixamo FBX"
      contains: "FlattenSkeleton"
  key_links:
    - from: "Berzerk.ContentPipeline/MixamoModelProcessor.cs"
      to: "Berzerk.ContentPipeline/SkinningData.cs"
      via: "new SkinningData(...) assigned to model.Tag"
      pattern: "model\\.Tag.*=.*new SkinningData"
    - from: "Berzerk.ContentPipeline/MixamoModelProcessor.cs"
      to: "Berzerk.ContentPipeline/SkinningDataWriter.cs"
      via: "SkinningDataWriter serializes SkinningData in Model.Tag during content build"
      pattern: "SkinningData"
---

<objective>
Rewrite MixamoModelProcessor to produce SkinningData and delete old pipeline types

Purpose: The processor is the bridge between Mixamo FBX files and the SkinningData types from Phase 1. The current processor produces incorrect AnimationData with wrong bone indices (depth-first traversal instead of FlattenSkeleton canonical ordering), has no bind pose or inverse bind pose extraction, and does not force SkinnedEffect. This plan replaces the processor internals with the canonical XNA SkinnedModelProcessor pattern and removes the superseded pipeline-side types.

Output: A working MixamoModelProcessor that produces SkinningData with correct bone ordering, bind/inverse bind pose, skeleton hierarchy, and animation clips. Old pipeline types deleted.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-pipeline-processor/02-RESEARCH.md
@.planning/phases/01-skinningdata-types-and-serialization/01-01-SUMMARY.md
@Berzerk.ContentPipeline/MixamoModelProcessor.cs
@Berzerk.ContentPipeline/SkinningData.cs
@Berzerk.ContentPipeline/SkinningDataClip.cs
@Berzerk.ContentPipeline/SkinningDataKeyframe.cs
@Berzerk.ContentPipeline/SkinningDataWriter.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite MixamoModelProcessor and delete old pipeline types</name>
  <files>
    Berzerk.ContentPipeline/MixamoModelProcessor.cs
    Berzerk.ContentPipeline/AnimationData.cs
    Berzerk.ContentPipeline/AnimationClip.cs
    Berzerk.ContentPipeline/Keyframe.cs
    Berzerk.ContentPipeline/AnimationDataWriter.cs
  </files>
  <action>
    **Delete** these 4 old pipeline-side files (they are superseded by Phase 1 SkinningData types):
    - `Berzerk.ContentPipeline/AnimationData.cs`
    - `Berzerk.ContentPipeline/AnimationClip.cs`
    - `Berzerk.ContentPipeline/Keyframe.cs`
    - `Berzerk.ContentPipeline/AnimationDataWriter.cs`

    **Rewrite** `Berzerk.ContentPipeline/MixamoModelProcessor.cs` to follow the XNA SkinnedModelProcessor canonical pattern. The complete implementation must include:

    **1. DefaultEffect override** (forces SkinnedEffect for all materials):
    ```csharp
    [DefaultValue(MaterialProcessorDefaultEffect.SkinnedEffect)]
    public override MaterialProcessorDefaultEffect DefaultEffect
    {
        get => MaterialProcessorDefaultEffect.SkinnedEffect;
        set { }
    }
    ```

    **2. Process() method** following this exact order (order is critical):
    - Step 1: `MeshHelper.FindSkeleton(input)` -- find skeleton root
    - Step 2: Handle `skeleton == null` case (animation-only/static model -- call `ProcessWithoutSkeleton`)
    - Step 3: `FlattenTransforms(input, skeleton)` -- bake non-bone transforms into geometry
    - Step 4: `MeshHelper.FlattenSkeleton(skeleton)` -- get canonical bone list
    - Step 5: Validate bone count <= 72 (SkinnedEffect.MaxBones), throw `InvalidContentException` if exceeded
    - Step 6: Extract `bindPose` (bone.Transform for each bone in flattened list)
    - Step 7: Extract `inverseBindPose` (Matrix.Invert(bone.AbsoluteTransform) for each bone)
    - Step 8: Extract `skeletonHierarchy` (bones.IndexOf(bone.Parent as BoneContent) for each bone -- root gets -1 because Parent is NodeContent, not BoneContent)
    - Step 9: Extract animations via `ProcessAnimations(skeleton, bones, input, context)`
    - Step 10: `model = base.Process(input, context)` -- standard mesh processing
    - Step 11: `model.Tag = new SkinningData(animationClips, bindPose, inverseBindPose, skeletonHierarchy)`
    - Log bone count, clip count, and bone names at important message level

    **3. FlattenTransforms static helper** (from XNA SkinningSample):
    - Recurse through `node.Children`
    - Skip the skeleton node itself (do NOT flatten skeleton transforms)
    - For each non-skeleton child: call `MeshHelper.TransformScene(child, child.Transform)` then set `child.Transform = Matrix.Identity`
    - Recurse into children

    **4. ProcessAnimations method** producing `Dictionary<string, SkinningDataClip>`:
    - Build `Dictionary<string, int> boneMap` from flattened bone list (bone.Name -> index)
    - Search for animations in multiple locations (preserve existing Mixamo-specific logic):
      a. First check `skeleton.Animations`
      b. Then check `input.Animations`
      c. Then check child nodes recursively
    - For each animation found:
      - Create `List<SkinningDataKeyframe>` from animation channels
      - For each channel: resolve bone name to index via boneMap, skip unknown bones with warning
      - For each keyframe in channel: create `new SkinningDataKeyframe(boneIndex, kf.Time, kf.Transform)`
      - Sort keyframes by Time then by Bone index (canonical ordering for cache-friendly playback)
      - Create `new SkinningDataClip(animation.Duration, keyframes)`
    - Return clips dictionary

    **5. ProcessWithoutSkeleton method** (for animation-only FBX files):
    - Extract animations from node hierarchy (same search as above but without skeleton)
    - Build bone indices from animation channel names (incrementing counter)
    - Create SkinningData with empty bind/inverse bind pose arrays (0 bones) and extracted animation clips
    - Call `base.Process(input, context)` and attach SkinningData to model.Tag
    - Log warning that skeleton data is missing (will be provided by base model at runtime merge)

    **6. Keep useful logging** from the existing processor:
    - Log model name at start
    - Log bone count and hierarchy
    - Log animation clip names, durations, keyframe counts
    - Log completion message

    Do NOT modify any runtime-side files (Berzerk/Source/Content/*). Those old runtime types remain until Phase 3/4.
    Do NOT modify Content.mgcb -- the processor name and reference are unchanged.
  </action>
  <verify>
    Run `dotnet build Berzerk.ContentPipeline/Berzerk.ContentPipeline.csproj` and confirm 0 errors.
    Run `dotnet build Berzerk.sln` and confirm 0 errors (runtime-side old types still compile independently).
    Verify the 4 old pipeline files are deleted: `ls Berzerk.ContentPipeline/AnimationData.cs` should fail.
    Verify `MixamoModelProcessor.cs` contains `FlattenSkeleton`, `DefaultEffect`, `SkinningData`, `InverseBindPose`.
  </verify>
  <done>
    MixamoModelProcessor.cs follows the canonical XNA SkinnedModelProcessor pattern: FlattenSkeleton for bone ordering, bind/inverse bind pose extraction, skeleton hierarchy, animation extraction with correct bone indices, DefaultEffect override for SkinnedEffect, SkinningData attached to Model.Tag. Old pipeline types (AnimationData, AnimationClip, Keyframe, AnimationDataWriter) are deleted. Pipeline project and full solution compile with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Attempt content build and verify pipeline output</name>
  <files></files>
  <action>
    Run the MGCB content build to verify the rewritten processor works with actual Mixamo FBX files.

    **Build command:**
    ```bash
    cd Berzerk && dotnet mgcb Content/Content.mgcb /rebuild
    ```

    Or if `dotnet mgcb` is not available as a tool:
    ```bash
    dotnet build Berzerk/Berzerk.csproj -t:BuildContent
    ```

    Or if content builds via the regular build process:
    ```bash
    dotnet build Berzerk/Berzerk.csproj
    ```

    **What to check in output:**
    1. Does the build succeed for `test-character.fbx`? (model with skeleton)
    2. Does the build succeed for `idle.fbx`, `walk.fbx`, `run.fbx`, `bash.fbx`? (animation files)
    3. Check pipeline log output for:
       - Bone count (expect ~65 for test-character.fbx)
       - Animation clip names and keyframe counts
       - Any warnings about missing bones or skeleton

    **If content build SUCCEEDS:**
    - Log the bone count and animation clip info
    - Verify XNB output files exist in `Berzerk/Content/bin/DesktopGL/`

    **If content build FAILS:**
    - Capture the error message
    - Determine if it is a processor logic error (fix it) or an FBX compatibility issue (document it as a known issue for investigation)
    - Common failure: Assimp FBX parsing produces unexpected node structure -- check if `FindSkeleton` returns null for test-character.fbx
    - If the failure is in FBX import (before the processor runs), that is an infrastructure issue, not a processor bug

    **Important:** The game itself will NOT run correctly after this change because the runtime still reads AnimationData from Model.Tag (Phase 3/4 will fix this). The content build succeeding is the success criterion, not the game running.
  </action>
  <verify>
    Content build command completes (check exit code).
    If successful: XNB files exist in `Berzerk/Content/bin/DesktopGL/Models/`.
    Pipeline log shows bone count and animation data for test-character.fbx.
  </verify>
  <done>
    Content build attempted with rewritten processor. If successful: XNB files produced with SkinningData. If failed: failure reason documented and categorized as processor bug (to fix) or infrastructure issue (to defer).
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk.sln` succeeds with 0 errors
2. `Berzerk.ContentPipeline/AnimationData.cs`, `AnimationClip.cs`, `Keyframe.cs`, `AnimationDataWriter.cs` do not exist
3. `MixamoModelProcessor.cs` contains: `FlattenSkeleton`, `DefaultEffect`, `SkinningData`, `Matrix.Invert`, `bone.AbsoluteTransform`
4. Content build attempted and result documented
</verification>

<success_criteria>
- MixamoModelProcessor produces SkinningData (not AnimationData) with canonical bone ordering from FlattenSkeleton
- Bind pose, inverse bind pose, and skeleton hierarchy are all extracted correctly
- SkinnedEffect is forced via DefaultEffect override
- Old pipeline types are deleted
- Pipeline project compiles with 0 errors
- Full solution compiles with 0 errors (runtime old types are untouched)
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-pipeline-processor/02-01-SUMMARY.md`
</output>
