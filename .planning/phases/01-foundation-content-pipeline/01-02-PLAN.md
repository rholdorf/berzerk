---
phase: 01-foundation-content-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Berzerk.ContentPipeline/MixamoModelProcessor.cs
  - Berzerk.ContentPipeline/MixamoModelWriter.cs
  - Berzerk.ContentPipeline/AnimationClip.cs
  - Berzerk.ContentPipeline/AnimationData.cs
  - Berzerk.ContentPipeline/Keyframe.cs
  - Berzerk.ContentPipeline/AnimationDataWriter.cs
  - Berzerk/Content/Content.mgcb
autonomous: true

must_haves:
  truths:
    - "FBX files are processed with verbose logging during content build"
    - "Skeleton structure is validated and logged during import"
    - "Animation data is extracted from FBX and serialized to XNB"
    - "Content build fails immediately if FBX import encounters errors"
  artifacts:
    - path: "Berzerk.ContentPipeline/MixamoModelProcessor.cs"
      provides: "Custom processor for Mixamo FBX files"
      contains: "[ContentProcessor"
      min_lines: 50
    - path: "Berzerk.ContentPipeline/AnimationData.cs"
      provides: "Runtime animation data structures"
      contains: "class AnimationData"
    - path: "Berzerk.ContentPipeline/AnimationClip.cs"
      provides: "Animation clip representation"
      contains: "class AnimationClip"
    - path: "Berzerk.ContentPipeline/Keyframe.cs"
      provides: "Keyframe representation"
      contains: "class Keyframe"
    - path: "Berzerk.ContentPipeline/AnimationDataWriter.cs"
      provides: "ContentTypeWriter for animation data"
      contains: "ContentTypeWriter<AnimationData>"
  key_links:
    - from: "Berzerk.ContentPipeline/MixamoModelProcessor.cs"
      to: "Microsoft.Xna.Framework.Content.Pipeline.Processors.ModelProcessor"
      via: "inheritance"
      pattern: ": ModelProcessor"
    - from: "Berzerk/Content/Content.mgcb"
      to: "Berzerk.ContentPipeline.dll"
      via: "/reference directive"
---

<objective>
Implement custom content pipeline processor for Mixamo FBX models with verbose logging

Purpose: The standard MonoGame FBX importer has known issues with Mixamo animations. This custom processor adds verbose logging to debug import issues, validates skeleton structure, and extracts animation data for runtime use.
Output: Working content pipeline processor that logs FBX import details and validates Mixamo models
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-content-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-content-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Animation Data Structures</name>
  <files>
    Berzerk.ContentPipeline/AnimationClip.cs
    Berzerk.ContentPipeline/AnimationData.cs
    Berzerk.ContentPipeline/Keyframe.cs
  </files>
  <action>
Create the data structures for representing animation data that will be serialized to XNB format.

1. Create AnimationClip.cs:
   - Properties: Name (string), Duration (TimeSpan), Keyframes (dictionary of bone name to keyframe list)
   - This represents a single named animation (idle, walk, etc.)

2. Create Keyframe.cs:
   - Properties: Time (TimeSpan), BoneIndex (int), Transform (Matrix)
   - Represents a single keyframe for a single bone

3. Create AnimationData.cs:
   - Properties: Clips (Dictionary of clip name to AnimationClip)
   - This is the top-level container that gets attached to Model.Tag
   - Include bone name to index mapping for runtime lookup

These structures will be populated by the processor and written to XNB by the writer. The runtime reader (in the game project) will deserialize them.

Keep structures serializable - use simple types that ContentTypeWriter can handle (primitives, arrays, dictionaries).
  </action>
  <verify>
```bash
dotnet build Berzerk.ContentPipeline/Berzerk.ContentPipeline.csproj
```
Build succeeds. No errors about missing types.
  </verify>
  <done>
Animation data structures exist and compile. Ready to be populated by processor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Mixamo Model Processor with Verbose Logging</name>
  <files>
    Berzerk.ContentPipeline/MixamoModelProcessor.cs
  </files>
  <action>
Create the custom content processor that extends ModelProcessor with Mixamo-specific handling and verbose logging.

1. Create MixamoModelProcessor.cs extending ModelProcessor:
   ```csharp
   [ContentProcessor(DisplayName = "Mixamo Model Processor")]
   public class MixamoModelProcessor : ModelProcessor
   ```

2. Override Process method to add:
   - Log entry point with model name
   - Find and validate skeleton using MeshHelper.FindSkeleton()
   - Log bone count and bone hierarchy structure
   - Log animation clip names and durations if present
   - Call base.Process() for standard model processing
   - Extract animation data from NodeContent.Animations
   - Store animation data in model.Tag for runtime access
   - Log completion or any warnings

3. Add helper methods:
   - CountBones(BoneContent bone) - recursively count bones
   - LogBoneHierarchy(BoneContent bone, int depth) - log bone tree structure
   - ExtractAnimations(NodeContent input) - extract animation clips

4. Use ContentProcessorContext.Logger for all logging:
   - LogMessage for info
   - LogWarning for potential issues
   - LogImportantMessage for critical info

5. If skeleton is missing, log warning but don't fail (model might be static)

6. If animations are missing, log info but don't fail (expected for static models)

Per CONTEXT.md: "Import failure handling: Fail the build" - throw ContentProcessorException for actual errors (corrupt data, unreadable bones, etc.)
  </action>
  <verify>
```bash
dotnet build Berzerk.ContentPipeline/Berzerk.ContentPipeline.csproj
```
Build succeeds. Processor class is recognized (has [ContentProcessor] attribute).
  </verify>
  <done>
MixamoModelProcessor exists with verbose logging. Inherits from ModelProcessor. Uses ContentProcessorContext.Logger for detailed output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Content Writer for Animation Data</name>
  <files>
    Berzerk.ContentPipeline/MixamoModelWriter.cs
    Berzerk.ContentPipeline/AnimationDataWriter.cs
  </files>
  <action>
Create content type writers to serialize animation data to XNB format.

1. Create AnimationDataWriter.cs:
   - Inherit from ContentTypeWriter<AnimationData>
   - Override Write() to serialize:
     - Number of clips
     - For each clip: name, duration, keyframe count, keyframes
   - Override GetRuntimeReader() to return reader type name
   - Override GetRuntimeType() to return AnimationData type

2. The writer must match what a future reader in the game project will expect.

3. For now, if there's no animation data, the model works as a static model. Animation playback comes in Plan 04.

4. Register the writer by ensuring it's public and has [ContentTypeWriter] attribute.

Note: The corresponding ContentTypeReader will be created in the game project (Plan 04) since readers run at runtime, not build time.
  </action>
  <verify>
```bash
dotnet build Berzerk.ContentPipeline/Berzerk.ContentPipeline.csproj
```
Build succeeds. No errors about ContentTypeWriter.
  </verify>
  <done>
AnimationDataWriter exists and compiles. Writer is registered with content pipeline via attribute.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full solution builds:
   ```bash
   dotnet build Berzerk.sln
   ```

2. Content pipeline project exports processor:
   Check that MixamoModelProcessor.cs has [ContentProcessor] attribute.

3. Animation structures are serializable:
   All types use primitives, arrays, or dictionaries that ContentTypeWriter supports.

4. No circular dependencies between processor and game project.
</verification>

<success_criteria>
- [ ] `dotnet build Berzerk.ContentPipeline/Berzerk.ContentPipeline.csproj` succeeds
- [ ] MixamoModelProcessor has [ContentProcessor] attribute
- [ ] Processor logs skeleton info via ContentProcessorContext.Logger
- [ ] AnimationData, AnimationClip, Keyframe classes exist
- [ ] AnimationDataWriter has [ContentTypeWriter] attribute
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-content-pipeline/01-02-SUMMARY.md`
</output>
