---
phase: 01-foundation-content-pipeline
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - Berzerk/Source/Graphics/AnimatedModel.cs
  - Berzerk/Source/Content/AnimationDataReader.cs
  - Berzerk/Source/Content/AnimationData.cs
  - Berzerk/Source/Content/AnimationClip.cs
  - Berzerk/Source/Content/Keyframe.cs
  - Berzerk/BerzerkGame.cs
  - Berzerk/Content/Content.mgcb
  - Berzerk/Content/Models/test-character.fbx
autonomous: false

must_haves:
  truths:
    - "Test Mixamo character model loads without errors"
    - "Model renders in 3D with correct lighting"
    - "Animation loading system extracts all animations from FBX"
    - "Animation playback shows visible bone movement"
    - "Content pipeline logs show FBX import details"
  artifacts:
    - path: "Berzerk/Source/Graphics/AnimatedModel.cs"
      provides: "Runtime animated model loading and rendering"
      contains: "class AnimatedModel"
      min_lines: 60
    - path: "Berzerk/Source/Content/AnimationDataReader.cs"
      provides: "ContentTypeReader for animation data"
      contains: "class AnimationDataReader"
    - path: "Berzerk/Source/Content/AnimationData.cs"
      provides: "Runtime animation data class"
      contains: "class AnimationData"
    - path: "Berzerk/Source/Content/AnimationClip.cs"
      provides: "Runtime animation clip class"
      contains: "class AnimationClip"
    - path: "Berzerk/Source/Content/Keyframe.cs"
      provides: "Runtime keyframe class"
      contains: "class Keyframe"
    - path: "Berzerk/Content/Models/test-character.fbx"
      provides: "Test Mixamo character with animations"
  key_links:
    - from: "Berzerk/Source/Graphics/AnimatedModel.cs"
      to: "ContentManager.Load<Model>"
      via: "content loading"
      pattern: "Content\\.Load<Model>"
    - from: "Berzerk/BerzerkGame.cs"
      to: "Berzerk/Source/Graphics/AnimatedModel.cs"
      via: "instantiation and rendering"
      pattern: "AnimatedModel"
    - from: "Berzerk/BerzerkGame.cs"
      to: "Berzerk/Source/Input/InputManager.cs"
      via: "keyboard input for animation switching"
      pattern: "_inputManager\\.IsKeyPressed\\(Keys\\.D"
    - from: "Berzerk/Source/Content/AnimationDataReader.cs"
      to: "Berzerk.ContentPipeline/AnimationDataWriter.cs"
      via: "serialization pair"

user_setup:
  - service: mixamo
    why: "Download test character with animations"
    account_required: true
    dashboard_config:
      - task: "Download character with 3+ animations in FBX 2013 format"
        location: "mixamo.com -> Characters -> Select character -> Download"
        details: "Export settings: FBX Binary (.fbx), With Skin, 30 FPS, No Keyframe Reduction. Download character with Idle, Walk, and Run animations bundled or separately."
---

<objective>
Load and render test Mixamo character with working animations

Purpose: This is the critical validation of Phase 1 - proving the FBX content pipeline works with Mixamo assets. If this fails, we need to diagnose and fix the pipeline before proceeding.
Output: Running game showing animated 3D character that responds to keyboard input to switch animations

Note: Plan scope is high due to end-to-end integration, but 2 checkpoints provide safety gates for human verification.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-content-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-content-pipeline/01-02-SUMMARY.md
@.planning/phases/01-foundation-content-pipeline/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Animation Data Reader and Runtime Classes</name>
  <files>
    Berzerk/Source/Content/AnimationDataReader.cs
    Berzerk/Source/Content/AnimationData.cs
    Berzerk/Source/Content/AnimationClip.cs
    Berzerk/Source/Content/Keyframe.cs
  </files>
  <action>
Create the runtime ContentTypeReader and matching runtime classes that deserialize animation data from XNB:

1. Create directory: Berzerk/Source/Content/

2. Create runtime animation classes (copies of content pipeline versions for runtime use):

   Create Keyframe.cs:
   - Properties: Time (TimeSpan), BoneIndex (int), Transform (Matrix)

   Create AnimationClip.cs:
   - Properties: Name (string), Duration (TimeSpan), Keyframes (dictionary of bone name to keyframe list)

   Create AnimationData.cs:
   - Properties: Clips (Dictionary of clip name to AnimationClip)
   - Include bone name to index mapping for runtime lookup

3. Create AnimationDataReader.cs:
   - Inherit from ContentTypeReader<AnimationData>
   - Override Read() to deserialize matching what AnimationDataWriter.Write() produces
   - Read number of clips
   - For each clip: read name, duration, keyframes
   - Reconstruct AnimationData, AnimationClip, Keyframe objects

4. Register reader with content pipeline by ensuring class has correct type parameter.

Important: The reader format MUST match the writer format exactly (same order, same types).
  </action>
  <verify>
```bash
dotnet build Berzerk/Berzerk.csproj
```
Build succeeds. Reader class and runtime animation classes compile.
  </verify>
  <done>
AnimationDataReader exists and compiles. Runtime animation classes (AnimationData, AnimationClip, Keyframe) exist in game project.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnimatedModel Class</name>
  <files>
    Berzerk/Source/Graphics/AnimatedModel.cs
  </files>
  <action>
Create the AnimatedModel class for loading and rendering 3D models with animations:

1. Create directory: Berzerk/Source/Graphics/

2. Create AnimatedModel.cs following pattern from RESEARCH.md:
   - Private Model _model field
   - Private Matrix[] _boneTransforms array
   - Private AnimationData _animationData (from Model.Tag after load)
   - Private current animation state (clip name, time)

3. LoadContent(ContentManager content, string modelPath):
   - Load model: _model = content.Load<Model>(modelPath)
   - Initialize bone transforms array
   - Extract AnimationData from _model.Tag (may be null for static models)
   - Log available animations to console

4. Update(GameTime gameTime):
   - If no animation data or no current clip, skip
   - Advance animation time
   - Loop when reaching clip duration
   - Update bone transforms from keyframes (interpolate between keyframes)
   - For initial version, just copy default bone transforms if interpolation is complex

5. Draw(Matrix world, Matrix view, Matrix projection):
   - Copy absolute bone transforms
   - For each mesh, for each BasicEffect:
     - EnableDefaultLighting()
     - PreferPerPixelLighting = true
     - Set World, View, Projection matrices
   - Draw each mesh

6. PlayAnimation(string clipName):
   - Set current clip and reset time to zero
   - Log animation change

7. GetAnimationNames():
   - Return list of available animation clip names

Use BasicEffect for now (default for FBX imports). Proper skinned animation may need SkinningEffect or custom shader in future phases.
  </action>
  <verify>
```bash
dotnet build Berzerk/Berzerk.csproj
```
Build succeeds. AnimatedModel class compiles.
  </verify>
  <done>
AnimatedModel class exists with LoadContent, Update, Draw, PlayAnimation methods. Uses BasicEffect for rendering.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Download Mixamo Test Character</name>
  <action>Download test character with animations from Mixamo</action>
  <instructions>
1. Go to https://mixamo.com and sign in (Adobe account required, free)

2. Browse Characters and select a simple humanoid character (e.g., "Y Bot", "X Bot", or any humanoid)

3. Download the character with multiple animations:
   - Select character, then go to Animations tab
   - Search for and add: "Idle", "Walking", "Running" (at minimum)
   - Download each with settings:
     - Format: FBX Binary (.fbx)
     - Skin: With Skin
     - Frames per Second: 30
     - Keyframe Reduction: none

   OR download character once with T-pose, then download animations separately

4. Place downloaded FBX file(s) in:
   Berzerk/Content/Models/test-character.fbx
   (If multiple files, name them: test-character.fbx, idle.fbx, walk.fbx, run.fbx)

5. Reply with the filename(s) you placed in Content/Models/
  </instructions>
  <resume-signal>Confirm files placed: "test-character.fbx" (or list filenames)</resume-signal>
</task>

<task type="auto">
  <name>Task 4: Configure Content Pipeline and Test Import</name>
  <files>
    Berzerk/Content/Content.mgcb
    Berzerk/BerzerkGame.cs
  </files>
  <action>
Configure the content pipeline to process the Mixamo FBX and integrate into game:

1. Update Content.mgcb to include the test character:
   ```
   #begin Models/test-character.fbx
   /importer:FbxImporter
   /processor:MixamoModelProcessor
   /build:Models/test-character.fbx
   ```

2. Build content and check logs:
   ```bash
   dotnet build Berzerk/Berzerk.csproj -v:detailed
   ```
   Look for MixamoModelProcessor log messages about skeleton and bones.

3. Update BerzerkGame.cs to test the model:

   In class:
   - Add private AnimatedModel _testModel;
   - Add camera matrices (view, projection)

   In LoadContent():
   - Create _testModel = new AnimatedModel()
   - Call _testModel.LoadContent(Content, "Models/test-character")
   - Set up camera:
     - View = Matrix.CreateLookAt(new Vector3(0, 1, 3), Vector3.Zero, Vector3.Up)
     - Projection = Matrix.CreatePerspectiveFieldOfView(MathHelper.PiOver4, GraphicsDevice.Viewport.AspectRatio, 0.1f, 100f)

   In Update():
   - Update model: _testModel.Update(gameTime)
   - Wire keyboard input to animation switching using InputManager from Plan 03:
     - Use _inputManager.IsKeyPressed(Keys.D1) to call _testModel.PlayAnimation() with first animation name
     - Use _inputManager.IsKeyPressed(Keys.D2) to call _testModel.PlayAnimation() with second animation name
     - Use _inputManager.IsKeyPressed(Keys.D3) to call _testModel.PlayAnimation() with third animation name
   - Get animation names from _testModel.GetAnimationNames() and map to keys 1, 2, 3

   In Draw():
   - Call GraphicsDevice.Clear(Color.CornflowerBlue)
   - Call _testModel.Draw(Matrix.Identity, _viewMatrix, _projectionMatrix)

4. If content build fails with FBX errors:
   - Check the build output for specific Assimp errors
   - Log the full error message
   - Try converting FBX using Blender if direct import fails (see RESEARCH.md pitfalls)
  </action>
  <verify>
1. Build with verbose output:
   ```bash
   dotnet build Berzerk.sln -v:detailed 2>&1 | grep -i "mixamo\|skeleton\|bone\|animation"
   ```
   Should see processor log messages.

2. Run the game:
   ```bash
   dotnet run --project Berzerk/Berzerk.csproj
   ```
   - Model should render (may be small/large, adjust camera if needed)
   - Press 1, 2, 3 to switch animations (see console output for animation changes)
  </verify>
  <done>
Test model loads and renders. Content pipeline logs show FBX details. Animation switching works via keyboard using _inputManager.IsKeyPressed(Keys.D1/D2/D3) -> _testModel.PlayAnimation().
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 foundation: MonoGame project with custom FBX content pipeline, input handling, and animated Mixamo character rendering</what-built>
  <how-to-verify>
1. Run the game:
   ```bash
   cd /Users/rui/src/pg/berzerk && dotnet run --project Berzerk/Berzerk.csproj
   ```

2. Verify these work:
   - [ ] Game window opens
   - [ ] 3D character model is visible (may need camera adjustment)
   - [ ] Press 1, 2, 3 to switch between animations
   - [ ] Animation playback shows movement (if animation extraction worked)
   - [ ] Press Escape to close game

3. Check content build logs:
   ```bash
   dotnet build Berzerk.sln -v:detailed 2>&1 | grep -i "mixamo"
   ```
   Should see skeleton/bone logging from MixamoModelProcessor.

If model doesn't render or animations don't work, describe what you see.
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria from ROADMAP.md:

1. MonoGame project builds and runs on macOS - verified in Plan 01
2. Custom FBX Content Pipeline processor imports Mixamo models - verified by content build logs
3. Test character model loads and renders with animations - verified by visual inspection
4. Keyboard and mouse input is detected and responds - verified by animation switching and Escape key

Full phase verification:
```bash
# Clean build
dotnet clean Berzerk.sln
dotnet build Berzerk.sln

# Run and test
dotnet run --project Berzerk/Berzerk.csproj
# 1. Window opens
# 2. Model visible
# 3. Keys 1/2/3 switch animations
# 4. Escape closes game
```
</verification>

<success_criteria>
- [ ] AnimationDataReader compiles and is registered
- [ ] Runtime AnimationData, AnimationClip, Keyframe classes exist in game project
- [ ] AnimatedModel class loads and renders models
- [ ] Test Mixamo character FBX is in Content/Models/
- [ ] Content.mgcb processes FBX with MixamoModelProcessor
- [ ] Content build logs show skeleton/bone information
- [ ] Game renders the 3D model
- [ ] Pressing 1/2/3 switches animations via _inputManager.IsKeyPressed() (logged to console at minimum)
- [ ] Escape key closes game
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-content-pipeline/01-04-SUMMARY.md`
</output>
