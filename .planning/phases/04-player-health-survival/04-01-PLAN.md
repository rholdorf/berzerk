---
phase: 04-player-health-survival
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Player/HealthSystem.cs
  - Berzerk/Source/UI/DamageVignette.cs
autonomous: true

must_haves:
  truths:
    - "HealthSystem tracks current HP from 0-200"
    - "HealthSystem fires OnDamageTaken event when damage applied"
    - "HealthSystem fires OnDeath event when HP reaches zero"
    - "DamageVignette displays red screen overlay when triggered"
    - "DamageVignette fades out over 0.3-0.5 seconds"
  artifacts:
    - path: "Berzerk/Source/Player/HealthSystem.cs"
      provides: "Health tracking with damage/heal methods and events"
      exports: ["HealthSystem", "CurrentHealth", "IsDead", "OnDamageTaken", "OnDeath"]
    - path: "Berzerk/Source/UI/DamageVignette.cs"
      provides: "Red vignette screen overlay with fade animation"
      exports: ["DamageVignette", "Trigger", "Update", "Draw"]
  key_links:
    - from: "HealthSystem"
      to: "DamageVignette"
      via: "OnDamageTaken event triggers vignette"
      pattern: "OnDamageTaken\\s*\\+=|\\?.Invoke"
---

<objective>
Create the core health tracking system and damage visual feedback for the player.

Purpose: Establish the foundation for player survival mechanics - health state management and immediate visual feedback when taking damage.
Output: HealthSystem component following AmmoSystem pattern, and DamageVignette overlay following ImpactEffect/Crosshair patterns.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-player-health-&-survival**/04-CONTEXT.md
@.planning/phases/04-player-health-&-survival**/04-RESEARCH.md

# Pattern references
@Berzerk/Source/Combat/AmmoSystem.cs
@Berzerk/Source/Combat/ImpactEffect.cs
@Berzerk/Source/UI/Crosshair.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HealthSystem component</name>
  <files>Berzerk/Source/Player/HealthSystem.cs</files>
  <action>
Create HealthSystem class following AmmoSystem pattern:

```csharp
namespace Berzerk.Source.Player;

public class HealthSystem
{
    public int CurrentHealth { get; private set; }
    public int MaxHealth { get; private set; } = 200;
    public int StartingHealth { get; private set; } = 100;
    public bool IsDead => CurrentHealth <= 0;

    public event Action OnDamageTaken;
    public event Action OnDeath;

    public HealthSystem() { CurrentHealth = StartingHealth; }

    public void TakeDamage(int amount)
    {
        if (IsDead) return;  // Ignore damage when dead
        CurrentHealth = Math.Max(0, CurrentHealth - amount);
        OnDamageTaken?.Invoke();
        if (IsDead) OnDeath?.Invoke();
    }

    public void Heal(int amount)
    {
        CurrentHealth = Math.Min(CurrentHealth + amount, MaxHealth);
    }

    public void Reset()
    {
        CurrentHealth = StartingHealth;
    }
}
```

Key decisions from CONTEXT.md:
- Starting health: 100 HP
- Max health: 200 HP (allows overheal via future pickups)
- No invincibility frames - damage always applies if not dead
- Events for damage feedback (OnDamageTaken) and state transitions (OnDeath)
  </action>
  <verify>
    `dotnet build Berzerk/` compiles successfully
  </verify>
  <done>
    HealthSystem.cs exists in Berzerk/Source/Player/ with public properties CurrentHealth, MaxHealth, IsDead and events OnDamageTaken, OnDeath
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DamageVignette overlay</name>
  <files>Berzerk/Source/UI/DamageVignette.cs</files>
  <action>
Create DamageVignette class following Crosshair/ImpactEffect patterns:

```csharp
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;

namespace Berzerk.UI;

public class DamageVignette
{
    private Texture2D _vignetteTexture;
    private float _alpha = 0f;
    private float _fadeOutTime = 0.4f;  // Fade out over 0.4 seconds
    private bool _isActive = false;

    public void LoadContent(GraphicsDevice graphicsDevice)
    {
        // Create vignette texture with red gradient from edges
        int width = 256;
        int height = 256;
        _vignetteTexture = new Texture2D(graphicsDevice, width, height);
        Color[] pixels = new Color[width * height];

        float centerX = width / 2f;
        float centerY = height / 2f;
        float maxDist = (float)Math.Sqrt(centerX * centerX + centerY * centerY);

        for (int y = 0; y < height; y++)
        {
            for (int x = 0; x < width; x++)
            {
                float dx = x - centerX;
                float dy = y - centerY;
                float dist = (float)Math.Sqrt(dx * dx + dy * dy);
                float intensity = dist / maxDist;
                intensity = intensity * intensity;  // Quadratic falloff
                pixels[y * width + x] = new Color(1f, 0f, 0f, intensity);
            }
        }
        _vignetteTexture.SetData(pixels);
    }

    public void Trigger()
    {
        _alpha = 1f;  // Instant flash to full intensity
        _isActive = true;
    }

    public void Update(float deltaTime)
    {
        if (!_isActive) return;

        // Exponential decay (project pattern from STATE.md)
        float decay = (float)Math.Pow(0.01, deltaTime / _fadeOutTime);
        _alpha *= decay;

        if (_alpha < 0.01f)
        {
            _alpha = 0f;
            _isActive = false;
        }
    }

    public void Draw(SpriteBatch spriteBatch, Viewport viewport)
    {
        if (_alpha <= 0f) return;

        spriteBatch.Draw(
            _vignetteTexture,
            new Rectangle(0, 0, viewport.Width, viewport.Height),
            Color.White * _alpha
        );
    }
}
```

Key decisions:
- Programmatic texture generation (no external assets) - matches Crosshair pattern
- Red vignette with quadratic falloff (darker edges, lighter center)
- Exponential decay for frame-rate independent fade (project pattern)
- Snap to zero when alpha < 0.01 to prevent permanent tint
  </action>
  <verify>
    `dotnet build Berzerk/` compiles successfully
  </verify>
  <done>
    DamageVignette.cs exists in Berzerk/Source/UI/ with LoadContent, Trigger, Update, Draw methods
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/` compiles without errors
2. Both new files exist:
   - Berzerk/Source/Player/HealthSystem.cs
   - Berzerk/Source/UI/DamageVignette.cs
3. HealthSystem has: CurrentHealth, MaxHealth (200), StartingHealth (100), IsDead, OnDamageTaken, OnDeath, TakeDamage, Heal, Reset
4. DamageVignette has: LoadContent, Trigger, Update, Draw
</verification>

<success_criteria>
- HealthSystem component compiles and exposes health state
- DamageVignette component compiles with programmatic texture
- Both follow established project patterns (AmmoSystem, ImpactEffect, Crosshair)
- No external asset dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/04-player-health-survival/04-01-SUMMARY.md`
</output>
