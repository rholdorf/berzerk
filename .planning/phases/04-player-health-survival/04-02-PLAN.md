---
phase: 04-player-health-survival
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/UI/ScreenFade.cs
  - Berzerk/Source/UI/HealthBar.cs
  - Berzerk/Source/UI/GameOverScreen.cs
  - Berzerk/Content/Font.spritefont
  - Berzerk/Content/Content.mgcb
autonomous: true

must_haves:
  truths:
    - "ScreenFade can fade screen to black over configurable duration"
    - "ScreenFade exposes IsComplete property for state transitions"
    - "HealthBar displays current HP as horizontal bar"
    - "HealthBar color changes based on health percentage"
    - "GameOverScreen displays centered text on black background"
  artifacts:
    - path: "Berzerk/Source/UI/ScreenFade.cs"
      provides: "Full-screen fade overlay with progress tracking"
      exports: ["ScreenFade", "Start", "Update", "Draw", "IsComplete", "Reset"]
    - path: "Berzerk/Source/UI/HealthBar.cs"
      provides: "Health bar UI with fill percentage"
      exports: ["HealthBar", "LoadContent", "Draw"]
    - path: "Berzerk/Source/UI/GameOverScreen.cs"
      provides: "Game over text display"
      exports: ["GameOverScreen", "LoadContent", "Draw"]
    - path: "Berzerk/Content/Font.spritefont"
      provides: "SpriteFont for text rendering"
      contains: "FontName"
  key_links:
    - from: "GameOverScreen"
      to: "Font.spritefont"
      via: "Content.Load<SpriteFont>"
      pattern: "Content\\.Load.*Font"
---

<objective>
Create death sequence visuals (fade to black), health bar display, and game over screen with restart prompt.

Purpose: Provide visual feedback for player death and game-over state, plus continuous health display during gameplay.
Output: ScreenFade for death animation, HealthBar for HP display, GameOverScreen for restart prompt, and SpriteFont asset.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-player-health-&-survival**/04-CONTEXT.md
@.planning/phases/04-player-health-&-survival**/04-RESEARCH.md

# Pattern references
@Berzerk/Source/UI/Crosshair.cs
@Berzerk/Source/Combat/ImpactEffect.cs
@Berzerk/Content/Content.mgcb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScreenFade overlay</name>
  <files>Berzerk/Source/UI/ScreenFade.cs</files>
  <action>
Create ScreenFade class for death sequence fade to black:

```csharp
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;
using System;

namespace Berzerk.UI;

public class ScreenFade
{
    private Texture2D _pixelTexture;
    private float _alpha = 0f;
    private float _targetAlpha = 0f;
    private float _duration = 1.5f;  // Default 1.5 seconds (CONTEXT: 1-2 seconds)
    private bool _isActive = false;

    public bool IsComplete => _isActive && Math.Abs(_alpha - _targetAlpha) < 0.01f;
    public float Alpha => _alpha;

    public void LoadContent(GraphicsDevice graphicsDevice)
    {
        // Create 1x1 white pixel texture
        _pixelTexture = new Texture2D(graphicsDevice, 1, 1);
        _pixelTexture.SetData(new[] { Color.White });
    }

    /// <summary>
    /// Start fade to target alpha over duration.
    /// </summary>
    public void Start(float targetAlpha, float duration)
    {
        _targetAlpha = targetAlpha;
        _duration = duration;
        _isActive = true;
    }

    /// <summary>
    /// Convenience method: fade to black.
    /// </summary>
    public void FadeToBlack(float duration = 1.5f)
    {
        Start(1f, duration);
    }

    /// <summary>
    /// Convenience method: fade from black (clear).
    /// </summary>
    public void FadeFromBlack(float duration = 0.5f)
    {
        Start(0f, duration);
    }

    public void Update(float deltaTime)
    {
        if (!_isActive) return;

        // Linear interpolation toward target
        float step = deltaTime / _duration;

        if (_alpha < _targetAlpha)
        {
            _alpha = Math.Min(_alpha + step, _targetAlpha);
        }
        else if (_alpha > _targetAlpha)
        {
            _alpha = Math.Max(_alpha - step, _targetAlpha);
        }

        // Snap when close enough
        if (Math.Abs(_alpha - _targetAlpha) < 0.01f)
        {
            _alpha = _targetAlpha;
        }
    }

    public void Draw(SpriteBatch spriteBatch, Viewport viewport)
    {
        if (_alpha <= 0f) return;

        spriteBatch.Draw(
            _pixelTexture,
            new Rectangle(0, 0, viewport.Width, viewport.Height),
            Color.Black * _alpha
        );
    }

    public void Reset()
    {
        _alpha = 0f;
        _targetAlpha = 0f;
        _isActive = false;
    }
}
```

Key decisions from CONTEXT.md:
- Fade to black over 1-2 seconds (using 1.5s default)
- Linear interpolation for predictable timing (not exponential decay)
- IsComplete property for state machine transitions
- 1x1 pixel texture pattern (from RESEARCH.md)
  </action>
  <verify>
    `dotnet build Berzerk/` compiles successfully
  </verify>
  <done>
    ScreenFade.cs exists with Start, FadeToBlack, Update, Draw, IsComplete, Reset
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HealthBar UI</name>
  <files>Berzerk/Source/UI/HealthBar.cs</files>
  <action>
Create HealthBar class for HP display:

```csharp
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;

namespace Berzerk.UI;

public class HealthBar
{
    private Texture2D _pixelTexture;

    // Bar dimensions and position
    private const int BarWidth = 200;
    private const int BarHeight = 20;
    private const int BarX = 20;
    private const int BarY = 20;
    private const int BorderWidth = 2;

    public void LoadContent(GraphicsDevice graphicsDevice)
    {
        // Create 1x1 white pixel texture
        _pixelTexture = new Texture2D(graphicsDevice, 1, 1);
        _pixelTexture.SetData(new[] { Color.White });
    }

    public void Draw(SpriteBatch spriteBatch, int currentHealth, int maxHealth)
    {
        // Calculate fill percentage (clamp to 0-1)
        float healthPercent = (float)currentHealth / maxHealth;
        healthPercent = MathHelper.Clamp(healthPercent, 0f, 1f);
        int fillWidth = (int)(BarWidth * healthPercent);

        // Determine fill color based on health percentage
        Color fillColor;
        if (healthPercent > 0.5f)
            fillColor = Color.LimeGreen;
        else if (healthPercent > 0.25f)
            fillColor = Color.Yellow;
        else
            fillColor = Color.Red;

        // Draw border (dark gray)
        spriteBatch.Draw(_pixelTexture,
            new Rectangle(BarX - BorderWidth, BarY - BorderWidth,
                          BarWidth + BorderWidth * 2, BarHeight + BorderWidth * 2),
            Color.DarkGray);

        // Draw background (black)
        spriteBatch.Draw(_pixelTexture,
            new Rectangle(BarX, BarY, BarWidth, BarHeight),
            Color.Black);

        // Draw health fill
        if (fillWidth > 0)
        {
            spriteBatch.Draw(_pixelTexture,
                new Rectangle(BarX, BarY, fillWidth, BarHeight),
                fillColor);
        }
    }
}
```

Key decisions:
- Top-left placement (20, 20) - standard HUD position
- 200x20 pixels - visible but not intrusive
- Color transitions: Green (>50%) -> Yellow (>25%) -> Red (<=25%)
- 1x1 pixel texture pattern (no external assets)
- Takes current/max health as parameters (decoupled from HealthSystem)
  </action>
  <verify>
    `dotnet build Berzerk/` compiles successfully
  </verify>
  <done>
    HealthBar.cs exists with LoadContent and Draw(currentHealth, maxHealth)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create GameOverScreen and SpriteFont</name>
  <files>
    Berzerk/Source/UI/GameOverScreen.cs
    Berzerk/Content/Font.spritefont
    Berzerk/Content/Content.mgcb
  </files>
  <action>
1. Create SpriteFont asset file (Berzerk/Content/Font.spritefont):

```xml
<?xml version="1.0" encoding="utf-8"?>
<XnaContent xmlns:Graphics="Microsoft.Xna.Framework.Content.Pipeline.Graphics">
  <Asset Type="Graphics:FontDescription">
    <FontName>Arial</FontName>
    <Size>32</Size>
    <Spacing>0</Spacing>
    <UseKerning>true</UseKerning>
    <Style>Bold</Style>
    <CharacterRegions>
      <CharacterRegion>
        <Start>&#32;</Start>
        <End>&#126;</End>
      </CharacterRegion>
    </CharacterRegions>
  </Asset>
</XnaContent>
```

2. Update Content.mgcb to include the font (add to existing file):

Add these lines to Content.mgcb:
```
#begin Font.spritefont
/importer:FontDescriptionImporter
/processor:FontDescriptionProcessor
/build:Font.spritefont
```

3. Create GameOverScreen class:

```csharp
using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Content;
using Microsoft.Xna.Framework.Graphics;

namespace Berzerk.UI;

public class GameOverScreen
{
    private SpriteFont _font;
    private Texture2D _pixelTexture;
    private string _message = "GAME OVER\n\nPress R to Restart";

    public void LoadContent(ContentManager content, GraphicsDevice graphicsDevice)
    {
        _font = content.Load<SpriteFont>("Font");

        // Create 1x1 pixel for background
        _pixelTexture = new Texture2D(graphicsDevice, 1, 1);
        _pixelTexture.SetData(new[] { Color.White });
    }

    public void Draw(SpriteBatch spriteBatch, Viewport viewport)
    {
        // Draw black background
        spriteBatch.Draw(_pixelTexture,
            new Rectangle(0, 0, viewport.Width, viewport.Height),
            Color.Black);

        // Measure text for centering
        Vector2 textSize = _font.MeasureString(_message);
        Vector2 screenCenter = new Vector2(viewport.Width / 2f, viewport.Height / 2f);
        Vector2 textPosition = screenCenter - textSize / 2f;

        // Draw text centered
        spriteBatch.DrawString(_font, _message, textPosition, Color.White);
    }
}
```

Key decisions from CONTEXT.md:
- Simple black screen with "Press R to restart" text
- Arial Bold 32pt for readability
- Centered text using MeasureString
- ASCII character range (32-126) covers all needed characters
  </action>
  <verify>
    `dotnet build Berzerk/` compiles successfully (font will be built by content pipeline)
  </verify>
  <done>
    - Font.spritefont exists in Content folder
    - Content.mgcb references Font.spritefont
    - GameOverScreen.cs exists with LoadContent and Draw
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/` compiles without errors
2. All new files exist:
   - Berzerk/Source/UI/ScreenFade.cs
   - Berzerk/Source/UI/HealthBar.cs
   - Berzerk/Source/UI/GameOverScreen.cs
   - Berzerk/Content/Font.spritefont
3. Content.mgcb includes Font.spritefont entry
4. Font builds successfully during compilation
</verification>

<success_criteria>
- ScreenFade provides fade-to-black with IsComplete for state detection
- HealthBar displays health as colored bar with percentage
- GameOverScreen displays centered text with SpriteFont
- SpriteFont asset compiles through content pipeline
- All components use 1x1 pixel texture pattern (no external assets)
</success_criteria>

<output>
After completion, create `.planning/phases/04-player-health-survival/04-02-SUMMARY.md`
</output>
