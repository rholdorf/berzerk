---
phase: 03-core-combat-system
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - Berzerk/BerzerkGame.cs
  - Berzerk/Source/Controllers/PlayerController.cs
  - Berzerk/Source/Graphics/DebugRenderer.cs
autonomous: false

must_haves:
  truths:
    - "Player fires by holding left mouse button"
    - "Projectiles spawn from player position and travel in camera direction"
    - "Projectiles visually appear as glowing cyan spheres"
    - "Projectiles collide with walls and show orange impact effect"
    - "Projectiles collide with test targets, targets flash red and are destroyed"
    - "Destroyed targets drop ammo pickups"
    - "Walking over pickups restores ammunition"
    - "Ammo counter visible in console output"
  artifacts:
    - path: "Berzerk/BerzerkGame.cs"
      provides: "Full combat system wiring"
      contains: "_projectileManager"
    - path: "Berzerk/Source/Controllers/PlayerController.cs"
      provides: "Shooting integration"
      contains: "_weaponSystem"
  key_links:
    - from: "BerzerkGame.Update"
      to: "WeaponSystem.Update"
      via: "fire input and camera direction"
      pattern: "_weaponSystem.Update.*IsLeftMouseHeld"
    - from: "WeaponSystem"
      to: "ThirdPersonCamera"
      via: "aim direction from camera forward"
      pattern: "camera.*Forward"
    - from: "TargetManager"
      to: "ProjectileManager"
      via: "collision check"
      pattern: "CheckProjectileCollisions.*GetActiveProjectiles"
---

<objective>
Wire all combat systems into BerzerkGame and PlayerController. Full integration with human verification checkpoint.

Purpose: Complete the combat loop: fire -> projectile travels -> hits wall/target -> feedback/destruction -> pickup -> ammo restored.
Output: Fully playable shooting mechanics ready for user testing.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-combat-system/03-CONTEXT.md
@.planning/phases/03-core-combat-system/03-02-SUMMARY.md
@.planning/phases/03-core-combat-system/03-03-SUMMARY.md
@Berzerk/BerzerkGame.cs
@Berzerk/Source/Controllers/PlayerController.cs
@Berzerk/Source/Graphics/ThirdPersonCamera.cs
@Berzerk/Source/Combat/WeaponSystem.cs
@Berzerk/Source/Combat/ProjectileManager.cs
@Berzerk/Source/Combat/ProjectileRenderer.cs
@Berzerk/Source/Combat/TargetManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ThirdPersonCamera to expose Forward vector for aiming</name>
  <files>
    Berzerk/Source/Graphics/ThirdPersonCamera.cs
  </files>
  <action>
Add public property to ThirdPersonCamera for aim direction:

public Vector3 Forward
{
    get
    {
        // Calculate camera forward from view matrix
        // Camera looks at target, so forward = normalized(target - position)
        Vector3 lookAt = _target.Position + new Vector3(0, 1f, 0);
        return Vector3.Normalize(lookAt - _currentPosition);
    }
}

This gives the direction from camera toward crosshair (screen center).
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    ThirdPersonCamera.Forward property returns aim direction
  </done>
</task>

<task type="auto">
  <name>Task 2: Add DebugRenderer methods for targets and pickups</name>
  <files>
    Berzerk/Source/Graphics/DebugRenderer.cs
  </files>
  <action>
Extend DebugRenderer to draw test targets and pickups.

Add DrawTargets(IReadOnlyList<TestTarget> targets, Matrix view, Matrix projection):
- For each active target:
  - Create BoundingBox from target.GetBoundingBox()
  - Use existing DrawBoundingBox method with target.GetColor()

Add DrawPickups(IReadOnlyList<AmmoPickup> pickups, Matrix view, Matrix projection):
- For each active pickup:
  - Draw small box at pickup.GetDisplayPosition() with Color.Yellow
  - Size ~0.4 units (smaller than targets)

If DrawBoundingBox doesn't exist with single box, add it:
- Extract the per-box drawing logic from DrawBoundingBoxes
- Create DrawBoundingBox(BoundingBox box, Matrix view, Matrix projection, Color color)
- Or just add a temporary box list and reuse DrawBoundingBoxes

Add required using statement: using Berzerk.Source.Combat;
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    DebugRenderer can draw targets as colored cubes and pickups as floating yellow boxes
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire combat systems into BerzerkGame</name>
  <files>
    Berzerk/BerzerkGame.cs
  </files>
  <action>
Add combat system fields at class level:
- private ProjectileManager _projectileManager;
- private ProjectileRenderer _projectileRenderer;
- private AmmoSystem _ammoSystem;
- private WeaponSystem _weaponSystem;
- private TargetManager _targetManager;

In Initialize():
- Create _projectileManager = new ProjectileManager();
- _projectileManager.Initialize(50);
- Create _ammoSystem = new AmmoSystem();
- Create _weaponSystem = new WeaponSystem(_ammoSystem, _projectileManager);
- Create _targetManager = new TargetManager();
- _targetManager.Initialize();

In LoadContent():
- After _testWalls are created:
  - _projectileManager.SetWallColliders(_testWalls);
- Create _projectileRenderer = new ProjectileRenderer(GraphicsDevice);
- Print controls help: "Left Mouse: Fire (hold for auto-fire)"

In Update(GameTime gameTime):
After _camera.Update(), add combat update:
```csharp
// Combat update
bool isFiring = _inputManager.IsLeftMouseHeld();
Vector3 spawnPos = _playerController.Transform.Position + Vector3.Up * 1.5f; // Shoulder height
Vector3 aimDir = _camera.Forward;
_weaponSystem.Update(gameTime, isFiring, spawnPos, aimDir);

float deltaTime = (float)gameTime.ElapsedGameTime.TotalSeconds;
_projectileManager.Update(deltaTime);
_targetManager.Update(deltaTime);
_targetManager.CheckProjectileCollisions(_projectileManager.GetActiveProjectiles());
_targetManager.CheckPickupCollection(_playerController.Transform.Position, _ammoSystem);

// Debug: Print ammo on fire
if (isFiring && _weaponSystem.CanFire)
{
    // Ammo info printed by weapon system or here
}
```

Add key binding to respawn targets (R key) for testing:
```csharp
if (_inputManager.IsKeyPressed(Keys.R))
{
    _targetManager.RespawnTargets();
    Console.WriteLine("Targets respawned!");
}
```

In Draw(GameTime gameTime):
After drawing character model and before 2D UI:
```csharp
// Draw projectiles
_projectileRenderer.Draw(_projectileManager.GetActiveProjectiles(), _camera.ViewMatrix, _camera.ProjectionMatrix);
_projectileRenderer.DrawEffects(_projectileManager.GetActiveEffects(), _camera.ViewMatrix, _camera.ProjectionMatrix);

// Draw targets and pickups
_debugRenderer.DrawTargets(_targetManager.GetTargets(), _camera.ViewMatrix, _camera.ProjectionMatrix);
_debugRenderer.DrawPickups(_targetManager.GetPickups(), _camera.ViewMatrix, _camera.ProjectionMatrix);
```

Add using statements at top:
- using Berzerk.Source.Combat;

Update console help text to include new controls.
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    BerzerkGame compiles with full combat system wired in
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify complete combat system</name>
  <what-built>
Complete laser combat system with:
- Hold left mouse to auto-fire (5-8 shots/sec)
- Glowing cyan projectiles travel through space
- Projectiles collide with walls (orange impact effect)
- Projectiles collide with green test targets (flash red, destroy)
- Destroyed targets drop yellow ammo pickups
- Walking near pickups auto-collects ammo
- R key respawns all targets for testing
  </what-built>
  <how-to-verify>
1. Run the game: `cd Berzerk && dotnet run`
2. Move with WASD, aim with crosshair (screen center)
3. Hold left mouse button - should fire cyan projectiles rapidly
4. Shoot at walls - orange flash appears, projectile disappears
5. Locate green cubes (test targets at positions: -5,0.5,-5 / 5,0.5,-5 / 0,0.5,-8)
6. Shoot targets - should flash red, then disappear after one hit
7. Yellow pickup should appear where target was destroyed
8. Walk near pickup - should auto-collect, console shows "Collected X ammo!"
9. Press R - targets respawn for more testing
10. Hold fire until magazine empties - should auto-reload from reserve
11. Check console for ammo count updates

Expected behavior:
- Smooth rapid fire with visible cooldown between shots
- Projectiles clearly visible as glowing spheres
- Clear visual feedback on impacts (walls and targets)
- Pickups float and bob slightly
- Ammo system works (depletes, auto-reloads, pickups refill)
  </how-to-verify>
  <resume-signal>Type "approved" if combat system works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Pre-checkpoint:
1. `dotnet build Berzerk/Berzerk.csproj` succeeds
2. Game runs without crashes
3. All combat features functional per checklist above
</verification>

<success_criteria>
All Phase 3 success criteria from ROADMAP.md:
1. Player aims with mouse cursor and fires on mouse click (hold for auto-fire)
2. Laser projectiles spawn and travel through 3D space visibly
3. Projectiles collide with walls and stop/disappear
4. Projectiles collide with test targets and register hits
5. Ammunition counter decreases when firing
6. Ammo pickups spawn and can be collected to restore ammunition
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-combat-system/03-04-SUMMARY.md`
</output>
