---
phase: 03-core-combat-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Combat/Projectile.cs
  - Berzerk/Source/Combat/ProjectileManager.cs
  - Berzerk/Source/Combat/AmmoSystem.cs
  - Berzerk/Source/Combat/WeaponSystem.cs
autonomous: true

must_haves:
  truths:
    - "Projectile objects can be spawned from a pool without allocation"
    - "Projectiles track position, velocity, and distance traveled"
    - "Magazine ammo depletes when consumed"
    - "Auto-reload pulls from reserve when magazine empties"
    - "Fire rate limits shots to 5-8 per second"
  artifacts:
    - path: "Berzerk/Source/Combat/Projectile.cs"
      provides: "Projectile state with activation/deactivation"
      contains: "class Projectile"
    - path: "Berzerk/Source/Combat/ProjectileManager.cs"
      provides: "Object pool and active projectile list"
      contains: "Queue<Projectile>"
    - path: "Berzerk/Source/Combat/AmmoSystem.cs"
      provides: "Magazine and reserve ammo tracking"
      contains: "TryConsumeAmmo"
    - path: "Berzerk/Source/Combat/WeaponSystem.cs"
      provides: "Fire rate cooldown timer"
      contains: "_cooldownTimer"
  key_links:
    - from: "WeaponSystem"
      to: "AmmoSystem"
      via: "TryConsumeAmmo call before spawn"
      pattern: "_ammoSystem.TryConsumeAmmo"
    - from: "WeaponSystem"
      to: "ProjectileManager"
      via: "Spawn call on fire"
      pattern: "_projectileManager.Spawn"
---

<objective>
Create the foundational combat infrastructure: projectile pooling, ammunition management, and weapon firing system.

Purpose: Establishes the data structures and logic that all combat features depend on. Object pooling prevents GC spikes during rapid fire.
Output: Four new classes in Combat folder ready for rendering and collision integration.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-combat-system/03-CONTEXT.md
@.planning/phases/03-core-combat-system/03-RESEARCH.md
@Berzerk/Source/Core/Transform.cs
@Berzerk/Source/Input/InputManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Projectile and ProjectileManager with object pooling</name>
  <files>
    Berzerk/Source/Combat/Projectile.cs
    Berzerk/Source/Combat/ProjectileManager.cs
  </files>
  <action>
Create new folder Berzerk/Source/Combat/ if needed.

Create Projectile.cs:
- Namespace: Berzerk.Source.Combat
- Public class Projectile with:
  - Transform property (reuse Core.Transform)
  - IsActive (bool) for pool state
  - Speed (float), Radius (float, default 0.2f), MaxDistance (float, default 75f from CONTEXT.md 50-100 range)
  - Private _velocity (Vector3), _distanceTraveled (float)
  - Activate(Vector3 position, Vector3 direction, float speed) - sets position, calculates velocity, resets distance, sets IsActive=true
  - Update(float deltaTime) - moves by velocity*deltaTime, accumulates distance, deactivates if distance >= MaxDistance
  - Deactivate() - sets IsActive=false
  - GetBoundingSphere() - returns new BoundingSphere(Transform.Position, Radius)
  - OnHitWall() and OnHitTarget(object target) - both call Deactivate() (effect spawning added later)

Create ProjectileManager.cs:
- Namespace: Berzerk.Source.Combat
- Public class ProjectileManager with:
  - Private _activeProjectiles (List<Projectile>)
  - Private _projectilePool (Queue<Projectile>)
  - Private const int POOL_SIZE = 50
  - Initialize(int poolSize = POOL_SIZE) - creates list and queue, pre-allocates poolSize projectiles
  - Spawn(Vector3 position, Vector3 direction, float speed) returns Projectile - dequeues from pool (or creates new if empty), activates, adds to active list
  - Update(float deltaTime) - iterates active list backwards, calls Update on each, returns inactive to pool
  - GetActiveProjectiles() returns IReadOnlyList<Projectile> for collision checks
  - ActiveCount property for debugging

Use GameTime.ElapsedGameTime.TotalSeconds pattern from research. Direction parameter should be normalized before use.
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
    Verify no compile errors in Combat folder
  </verify>
  <done>
    Projectile.cs and ProjectileManager.cs compile, projectile pooling pattern implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AmmoSystem and WeaponSystem with fire rate control</name>
  <files>
    Berzerk/Source/Combat/AmmoSystem.cs
    Berzerk/Source/Combat/WeaponSystem.cs
  </files>
  <action>
Create AmmoSystem.cs:
- Namespace: Berzerk.Source.Combat
- Public class AmmoSystem with:
  - CurrentMagazine (int, get; private set)
  - MaxMagazineSize (int) = 25
  - ReserveAmmo (int, get; private set)
  - MaxReserveAmmo (int) = 125 (within CONTEXT.md 100-150 range)
  - Constructor sets CurrentMagazine = MaxMagazineSize, ReserveAmmo = MaxReserveAmmo
  - TryConsumeAmmo() returns bool - decrements magazine if >0, returns true. If magazine=0 and reserve>0, auto-reloads then retries. Returns false if completely empty.
  - Reload() - calculates ammo needed, transfers from reserve to magazine
  - AddAmmo(int amount) - adds to reserve, capped at MaxReserveAmmo
  - TotalAmmo property = CurrentMagazine + ReserveAmmo
  - IsEmpty property = TotalAmmo == 0

Create WeaponSystem.cs:
- Namespace: Berzerk.Source.Combat
- Public class WeaponSystem with:
  - Private _fireRate = 6.5f (within CONTEXT.md 5-8 range, 6.5 shots/sec)
  - Private _cooldownTimer = 0f
  - Private _ammoSystem (AmmoSystem reference)
  - Private _projectileManager (ProjectileManager reference)
  - Private _projectileSpeed = 50f (within CONTEXT.md 40-60 range)
  - Constructor(AmmoSystem ammo, ProjectileManager projectiles) - stores references
  - Update(GameTime gameTime, bool wantsToFire, Vector3 spawnPosition, Vector3 aimDirection) - decrements cooldown by deltaTime, if wantsToFire and cooldown<=0 and ammo.TryConsumeAmmo(), spawn projectile and reset cooldown to 1/fireRate
  - CanFire property - returns cooldown <= 0 and !ammo.IsEmpty
  - CurrentAmmo property passthrough to ammo.CurrentMagazine
  - ReserveAmmo property passthrough to ammo.ReserveAmmo

Follow frame-rate independent timing pattern from research: use (float)gameTime.ElapsedGameTime.TotalSeconds.
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
    Verify no compile errors
  </verify>
  <done>
    AmmoSystem with magazine/reserve and auto-reload, WeaponSystem with fire rate limiting both compile
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `dotnet build Berzerk/Berzerk.csproj` succeeds
2. Four new files exist in Berzerk/Source/Combat/
3. No runtime dependencies yet (integration in Plan 04)
</verification>

<success_criteria>
- Projectile class tracks position, velocity, distance with activate/deactivate
- ProjectileManager implements object pooling with Queue
- AmmoSystem implements magazine + reserve with auto-reload
- WeaponSystem implements fire rate with cooldown timer
- All four classes compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-combat-system/03-01-SUMMARY.md`
</output>
