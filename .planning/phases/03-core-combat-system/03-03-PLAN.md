---
phase: 03-core-combat-system
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Berzerk/Source/Combat/TestTarget.cs
  - Berzerk/Source/Combat/AmmoPickup.cs
  - Berzerk/Source/Combat/TargetManager.cs
autonomous: true

must_haves:
  truths:
    - "Test targets render as colored cubes in 3D space"
    - "Targets change color when hit by projectiles"
    - "Destroyed targets spawn ammo pickups at their position"
    - "Ammo pickups can be collected by player proximity"
  artifacts:
    - path: "Berzerk/Source/Combat/TestTarget.cs"
      provides: "Destructible target with hit feedback"
      contains: "class TestTarget"
    - path: "Berzerk/Source/Combat/AmmoPickup.cs"
      provides: "Collectable ammo with auto-collect"
      contains: "class AmmoPickup"
    - path: "Berzerk/Source/Combat/TargetManager.cs"
      provides: "Manages targets, pickups, and projectile-target collision"
      contains: "class TargetManager"
  key_links:
    - from: "TargetManager"
      to: "TestTarget"
      via: "projectile collision check"
      pattern: "Intersects.*targetSphere"
    - from: "TestTarget destruction"
      to: "AmmoPickup spawn"
      via: "spawn pickup at target position"
      pattern: "SpawnPickup.*target.Position"
---

<objective>
Create test targets (colored cubes) that can be hit by projectiles and spawn ammo pickups when destroyed.

Purpose: Validates projectile-target collision and pickup mechanics. Simple colored cubes per CONTEXT.md decision.
Output: TestTarget, AmmoPickup, and TargetManager classes ready for integration.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-combat-system/03-CONTEXT.md
@.planning/phases/03-core-combat-system/03-RESEARCH.md
@.planning/phases/03-core-combat-system/03-01-SUMMARY.md
@Berzerk/Source/Combat/Projectile.cs
@Berzerk/Source/Combat/AmmoSystem.cs
@Berzerk/Source/Graphics/DebugRenderer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestTarget with hit feedback and destruction</name>
  <files>
    Berzerk/Source/Combat/TestTarget.cs
  </files>
  <action>
Create TestTarget.cs:
- Namespace: Berzerk.Source.Combat
- Public class TestTarget with:
  - Position (Vector3)
  - Size (float) = 1f (1 unit cube)
  - Radius (float) = 0.7f (collision sphere, slightly smaller than cube diagonal)
  - IsActive (bool)
  - IsHit (bool) - for visual feedback (color change)
  - HitPoints (int) = 1 (one hit to destroy for arcade feel)
  - Private _hitFlashTimer = 0f
  - Private const float HIT_FLASH_DURATION = 0.1f

Constructor(Vector3 position):
- Sets position, IsActive = true, IsHit = false

GetBoundingSphere() returns new BoundingSphere(Position, Radius)

GetBoundingBox() returns BoundingBox around position with Size extents:
- Min = Position - new Vector3(Size/2)
- Max = Position + new Vector3(Size/2)

OnHit():
- Decrement HitPoints
- Set IsHit = true, _hitFlashTimer = HIT_FLASH_DURATION
- If HitPoints <= 0, set IsActive = false (destroyed)
- Return IsActive (true = still alive, false = destroyed)

Update(float deltaTime):
- If IsHit and _hitFlashTimer > 0:
  - _hitFlashTimer -= deltaTime
  - If timer <= 0, reset IsHit = false

GetColor() returns Color:
- If !IsActive, return Color.Transparent
- If IsHit, return Color.Red (flash on hit)
- Else return Color.Green (normal state)
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    TestTarget compiles with hit detection, visual feedback, and destruction
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AmmoPickup with auto-collect on player proximity</name>
  <files>
    Berzerk/Source/Combat/AmmoPickup.cs
  </files>
  <action>
Create AmmoPickup.cs:
- Namespace: Berzerk.Source.Combat
- Public class AmmoPickup with:
  - Position (Vector3)
  - IsActive (bool)
  - AmmoAmount (int) = 40 (within CONTEXT.md 30-50 range)
  - CollectRadius (float) = 2f (generous auto-collect radius per research recommendation)
  - Private _bobOffset = 0f (for floating animation)
  - Private _bobSpeed = 3f
  - Private _bobHeight = 0.3f

Constructor(Vector3 position):
- Sets position, IsActive = true

Activate(Vector3 position):
- Sets Position, IsActive = true (for pooling)

Update(float deltaTime):
- Update bobbing: _bobOffset = sin(_bobOffset + deltaTime * _bobSpeed) * _bobHeight
- (Alternative: accumulate time and use sin(time * speed) * height)

GetDisplayPosition() returns Vector3:
- Position + Vector3.Up * (0.5f + _bobOffset) - floats above ground with bob

CheckCollection(Vector3 playerPosition) returns bool:
- If !IsActive, return false
- Return Vector3.Distance(Position, playerPosition) <= CollectRadius

Collect():
- Sets IsActive = false
- Returns AmmoAmount (caller adds to AmmoSystem)

GetColor() returns Color.Yellow (distinct from targets)
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    AmmoPickup compiles with auto-collect and floating animation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TargetManager to handle targets, pickups, and collisions</name>
  <files>
    Berzerk/Source/Combat/TargetManager.cs
  </files>
  <action>
Create TargetManager.cs:
- Namespace: Berzerk.Source.Combat
- Public class TargetManager with:
  - Private List<TestTarget> _targets = new()
  - Private List<AmmoPickup> _pickups = new()
  - Private Queue<AmmoPickup> _pickupPool = new() (pool size 10)

Initialize():
- Pre-populate pickup pool
- Create test targets at fixed positions for Phase 3 validation:
  - new TestTarget(new Vector3(-5, 0.5f, -5))
  - new TestTarget(new Vector3(5, 0.5f, -5))
  - new TestTarget(new Vector3(0, 0.5f, -8))
  - Add each to _targets list

Update(float deltaTime):
- Update all active targets
- Update all active pickups
- Return inactive pickups to pool (iterate backwards)

CheckProjectileCollisions(IReadOnlyList<Projectile> projectiles):
- For each active projectile:
  - Get projectile BoundingSphere
  - For each active target:
    - If sphere.Intersects(target.GetBoundingSphere()):
      - bool destroyed = !target.OnHit()
      - projectile.OnHitTarget(target)
      - If destroyed, call SpawnPickup(target.Position)
      - Break target loop (projectile hit something)

CheckPickupCollection(Vector3 playerPosition, AmmoSystem ammoSystem):
- For each active pickup:
  - If pickup.CheckCollection(playerPosition):
    - int amount = pickup.Collect()
    - ammoSystem.AddAmmo(amount)
    - Console.WriteLine($"Collected {amount} ammo!") for debugging

SpawnPickup(Vector3 position) private:
- Dequeue from pool or create new
- pickup.Activate(position)
- Add to _pickups list

GetTargets() returns IReadOnlyList<TestTarget>
GetPickups() returns IReadOnlyList<AmmoPickup>

RespawnTargets() - for testing: resets all targets to active with full HP, clears pickups
  </action>
  <verify>
    dotnet build Berzerk/Berzerk.csproj
  </verify>
  <done>
    TargetManager handles target spawning, projectile collision, pickup spawning and collection
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build Berzerk/Berzerk.csproj` succeeds
2. TestTarget.cs, AmmoPickup.cs, TargetManager.cs exist in Combat folder
3. All three classes compile without errors
</verification>

<success_criteria>
- TestTarget has BoundingSphere for collision, hit feedback, destruction state
- AmmoPickup has auto-collect with generous radius, floating animation
- TargetManager creates test targets, handles projectile-target collision, spawns pickups
- Collection notifies AmmoSystem to add reserve ammo
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-combat-system/03-03-SUMMARY.md`
</output>
