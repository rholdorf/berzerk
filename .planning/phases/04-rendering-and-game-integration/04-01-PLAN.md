---
phase: 04-rendering-and-game-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Graphics/AnimatedModel.cs
autonomous: true

must_haves:
  truths:
    - "AnimatedModel.Draw() calls SkinnedEffect.SetBoneTransforms() with skinTransforms from AnimationPlayer"
    - "Model renders using SkinnedEffect instead of BasicEffect -- no rigid-body bone transform approach"
    - "If Content Pipeline produces BasicEffect despite DefaultEffect override, effects are replaced at load time"
    - "Sphere/joint mesh sorting logic is removed -- single skinned mesh loop replaces it"
    - "The _boneTransforms array and CopyAbsoluteBoneTransformsTo are removed (rigid-body rendering dead code)"
  artifacts:
    - path: "Berzerk/Source/Graphics/AnimatedModel.cs"
      provides: "SkinnedEffect-based Draw loop with SetBoneTransforms, load-time effect replacement fallback"
      contains: "SetBoneTransforms"
  key_links:
    - from: "Berzerk/Source/Graphics/AnimatedModel.cs"
      to: "AnimationPlayer.GetSkinTransforms()"
      via: "Draw() calls _animationPlayer.GetSkinTransforms() and passes result to SkinnedEffect.SetBoneTransforms()"
      pattern: "SetBoneTransforms.*GetSkinTransforms|GetSkinTransforms.*SetBoneTransforms"
    - from: "Berzerk/Source/Graphics/AnimatedModel.cs"
      to: "SkinnedEffect"
      via: "Effect type check in Draw loop with is pattern match"
      pattern: "effect is SkinnedEffect"
---

<objective>
Switch AnimatedModel from rigid-body BasicEffect rendering to GPU-skinned SkinnedEffect rendering, connecting the AnimationPlayer's skinTransforms output to the GPU.

Purpose: This is the moment the entire 3-phase animation pipeline becomes visible. AnimationPlayer already computes skinTransforms every frame, but Draw() still uses BasicEffect with per-mesh bone transforms, keeping the character in T-pose. Switching to SkinnedEffect.SetBoneTransforms() enables per-vertex deformation.

Output: AnimatedModel.cs with SkinnedEffect Draw loop, load-time effect replacement fallback, and all rigid-body rendering code removed.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rendering-and-game-integration/04-RESEARCH.md
@.planning/phases/03-animation-runtime/03-02-SUMMARY.md
@Berzerk/Source/Graphics/AnimatedModel.cs
@Berzerk/Source/Graphics/AnimationPlayer.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace BasicEffect Draw with SkinnedEffect Draw and add load-time effect replacement</name>
  <files>Berzerk/Source/Graphics/AnimatedModel.cs</files>
  <action>
Rewrite AnimatedModel.cs with two changes:

**1. LoadContent -- add effect type diagnostic and replacement fallback:**

After `_model = content.Load<Model>(modelPath)`, add a method call `EnsureSkinnedEffects(graphicsDevice)` that:
- Iterates all `ModelMeshPart` in all `ModelMesh`
- Logs the actual effect type of each mesh part (`Console.WriteLine`)
- If any `part.Effect is BasicEffect`, replaces it with a new `SkinnedEffect(graphicsDevice)` copying: DiffuseColor, SpecularColor, SpecularPower, EmissiveColor, Alpha, Texture. Set `WeightsPerVertex = 4` and `PreferPerPixelLighting = true`.
- This handles MonoGame Issue #3057 where DefaultEffect = SkinnedEffect may not propagate.

IMPORTANT: LoadContent does not currently receive a GraphicsDevice parameter. Change the signature to `LoadContent(ContentManager content, string modelPath, GraphicsDevice graphicsDevice)`. Update callers: BerzerkGame.cs passes `GraphicsDevice`, EnemyRenderer.cs passes `_graphicsDevice`. Both already have access to GraphicsDevice.

Alternatively, EnsureSkinnedEffects can be called lazily in Draw (which already receives graphicsDevice) on first invocation, using a `_effectsChecked` bool flag. This avoids changing LoadContent's signature and all its callers. **Prefer this lazy approach** to minimize caller changes.

**2. Draw -- replace entire body:**

Remove: The sphere/joint mesh sorting lists, the sphereMeshes/otherMeshes split, the two `foreach BasicEffect` draw loops, and the `_boneTransforms[mesh.ParentBone.Index] * world` pattern.

Replace with the canonical XNA SkinnedEffect draw loop:
```csharp
public void Draw(GraphicsDevice graphicsDevice, Matrix world, Matrix view, Matrix projection)
{
    if (_model == null) return;

    // One-time effect replacement on first draw (handles Issue #3057)
    if (!_effectsChecked)
    {
        EnsureSkinnedEffects(graphicsDevice);
        _effectsChecked = true;
    }

    // Get skin transforms from animation player
    Matrix[]? skinTransforms = _animationPlayer?.GetSkinTransforms();

    foreach (ModelMesh mesh in _model.Meshes)
    {
        foreach (Effect effect in mesh.Effects)
        {
            if (effect is SkinnedEffect skinnedEffect)
            {
                if (skinTransforms != null)
                    skinnedEffect.SetBoneTransforms(skinTransforms);
                skinnedEffect.World = world;
                skinnedEffect.View = view;
                skinnedEffect.Projection = projection;
                skinnedEffect.EnableDefaultLighting();
                skinnedEffect.PreferPerPixelLighting = true;
            }
            else if (effect is BasicEffect basicEffect)
            {
                // Fallback for static models without skinning data
                basicEffect.World = world;
                basicEffect.View = view;
                basicEffect.Projection = projection;
                basicEffect.EnableDefaultLighting();
                basicEffect.PreferPerPixelLighting = true;
            }
        }
        mesh.Draw();
    }
}
```

Keep the RasterizerState and DepthStencilState setup at the top of Draw.

**3. Remove dead code:**

- Delete `private Matrix[] _boneTransforms = Array.Empty<Matrix>();` field
- Delete `_boneTransforms = new Matrix[_model.Bones.Count];` from LoadContent
- Delete `_model.CopyAbsoluteBoneTransformsTo(_boneTransforms);` from LoadContent
- Delete the comment about "Initialize bone transforms array (used by Draw with BasicEffect)"
- Add `private bool _effectsChecked;` field

**Anti-patterns to avoid (from research):**
- Do NOT create SkinnedEffect per-frame (memory leak). EnsureSkinnedEffects runs once.
- Do NOT pass world matrix as rootTransform in AnimationPlayer.Update. World goes on SkinnedEffect.World only.
- Do NOT use `_boneTransforms[mesh.ParentBone.Index] * world` -- that is rigid-body, not skinning.
  </action>
  <verify>
Run `dotnet build Berzerk/Berzerk.csproj` -- must compile with zero errors. Then run the game briefly to confirm it launches without crash. The character should no longer be in T-pose (visual verification deferred to Phase 5, but a crash-free launch with visible rendering is the bar here).
  </verify>
  <done>
AnimatedModel.Draw() uses SkinnedEffect.SetBoneTransforms(skinTransforms) in a single mesh loop. Load-time effect replacement handles BasicEffect-to-SkinnedEffect conversion. No rigid-body _boneTransforms code remains. Game compiles and runs without crashes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update EnemyRenderer.LoadRobotModels and BerzerkGame.LoadContent callers (if needed)</name>
  <files>Berzerk/Source/Enemies/EnemyRenderer.cs, Berzerk/BerzerkGame.cs</files>
  <action>
If Task 1 used the lazy EnsureSkinnedEffects approach (called in Draw on first invocation), then no caller changes are needed for LoadContent -- skip this task's caller update work.

If Task 1 changed the LoadContent signature, update these two callers:
- `Berzerk/BerzerkGame.cs` line ~144: `_playerModel.LoadContent(Content, "Models/test-character", GraphicsDevice)`
- `Berzerk/Source/Enemies/EnemyRenderer.cs` lines ~59,65,72: pass `_graphicsDevice` as third argument to each `LoadContent` call

Either way, verify both files compile cleanly.

Additionally, remove the Update comment in AnimatedModel.Update() that says "NOTE: skinTransforms are computed but not sent to GPU yet (Phase 4 switches to SkinnedEffect)." -- Phase 4 is now done, this comment is stale.
  </action>
  <verify>
Run `dotnet build Berzerk/Berzerk.csproj` -- zero errors. Grep for "Phase 4" in AnimatedModel.cs -- should return nothing (stale comment removed).
  </verify>
  <done>
All callers compile. No stale Phase 4 TODO comments remain in AnimatedModel.cs. Game builds and runs.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/Berzerk.csproj` compiles with zero errors
2. AnimatedModel.Draw() contains `SetBoneTransforms` call (grep confirms)
3. AnimatedModel.Draw() does NOT contain `_boneTransforms[mesh.ParentBone.Index]` (grep confirms absence)
4. AnimatedModel.cs does NOT contain `CopyAbsoluteBoneTransformsTo` (grep confirms absence)
5. EnsureSkinnedEffects method exists and handles BasicEffect-to-SkinnedEffect replacement
6. Game launches without crashing (visual correctness verified in Phase 5)
</verification>

<success_criteria>
- SkinnedEffect.SetBoneTransforms() is called each frame with AnimationPlayer output
- BasicEffect rigid-body rendering code is completely removed
- Load-time effect replacement handles MonoGame Issue #3057
- Game compiles and runs without crashes
</success_criteria>

<output>
After completion, create `.planning/phases/04-rendering-and-game-integration/04-01-SUMMARY.md`
</output>
