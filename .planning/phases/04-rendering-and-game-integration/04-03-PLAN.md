---
phase: 04-rendering-and-game-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Berzerk/Source/Graphics/AnimatedModel.cs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "SkinnedEffect has TextureEnabled=true when a Texture is assigned, so the model renders with surface texture detail instead of flat gray"
    - "Both EnsureSkinnedEffects (load-time replacement) and the Draw loop set TextureEnabled correctly"
  artifacts:
    - path: "Berzerk/Source/Graphics/AnimatedModel.cs"
      provides: "TextureEnabled=true on SkinnedEffect when Texture is non-null"
      contains: "TextureEnabled"
  key_links:
    - from: "EnsureSkinnedEffects"
      to: "SkinnedEffect.TextureEnabled"
      via: "Set TextureEnabled = true when copying Texture from BasicEffect"
      pattern: "TextureEnabled\\s*=\\s*true"
---

<objective>
Fix missing TextureEnabled property on SkinnedEffect, which causes models to render as solid dark gray without texture detail.

Purpose: EnsureSkinnedEffects copies the Texture property from BasicEffect to SkinnedEffect but never sets TextureEnabled=true. Unlike BasicEffect (which enables texturing automatically when a Texture is set), SkinnedEffect requires TextureEnabled to be explicitly set to true. Without this, the GPU shader ignores the texture and renders flat diffuse color only.

Output: AnimatedModel.cs with TextureEnabled=true set wherever SkinnedEffect gets a Texture assigned.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rendering-and-game-integration/04-VERIFICATION.md
@.planning/phases/04-rendering-and-game-integration/04-01-SUMMARY.md
@Berzerk/Source/Graphics/AnimatedModel.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TextureEnabled=true to EnsureSkinnedEffects and Draw loop</name>
  <files>Berzerk/Source/Graphics/AnimatedModel.cs</files>
  <action>
Two surgical changes in AnimatedModel.cs:

**1. EnsureSkinnedEffects method (around line 146):**

In the SkinnedEffect object initializer block where material properties are copied from BasicEffect, add `TextureEnabled` after the `Texture` property:

```csharp
var skinned = new SkinnedEffect(graphicsDevice)
{
    DiffuseColor = basic.DiffuseColor,
    SpecularColor = basic.SpecularColor,
    SpecularPower = basic.SpecularPower,
    EmissiveColor = basic.EmissiveColor,
    Alpha = basic.Alpha,
    Texture = basic.Texture,
    TextureEnabled = basic.Texture != null,   // <-- ADD THIS LINE
    WeightsPerVertex = 4,
    PreferPerPixelLighting = true
};
```

The condition `basic.Texture != null` ensures TextureEnabled is only true when there is actually a texture to display. This matches BasicEffect behavior where texturing is only active when both TextureEnabled and Texture are set.

**2. Draw loop SkinnedEffect branch (around line 104):**

The Draw loop currently sets World/View/Projection and lighting on the SkinnedEffect but does NOT set TextureEnabled. This is fine because EnsureSkinnedEffects already created the effect with the correct TextureEnabled value -- the Draw loop does not need to re-set it every frame since the effect persists.

However, for defensive correctness, add `skinnedEffect.TextureEnabled = (skinnedEffect.Texture != null);` inside the SkinnedEffect branch AFTER the existing property assignments. This ensures TextureEnabled is correct even if someone replaces the effect outside of EnsureSkinnedEffects:

```csharp
if (effect is SkinnedEffect skinnedEffect)
{
    if (skinTransforms != null)
        skinnedEffect.SetBoneTransforms(skinTransforms);
    skinnedEffect.World = world;
    skinnedEffect.View = view;
    skinnedEffect.Projection = projection;
    skinnedEffect.EnableDefaultLighting();
    skinnedEffect.PreferPerPixelLighting = true;
    skinnedEffect.TextureEnabled = skinnedEffect.Texture != null;  // <-- ADD THIS LINE
}
```

**What NOT to do:**
- Do NOT change any other properties or method signatures
- Do NOT touch the BasicEffect fallback branch
- Do NOT change LoadContent, Update, PlayAnimation, AddAnimationsFrom, or any other method
  </action>
  <verify>
1. Run `dotnet build Berzerk/Berzerk.csproj` -- must compile with zero errors.
2. Grep for `TextureEnabled` in AnimatedModel.cs -- must find at least 2 occurrences (one in EnsureSkinnedEffects, one in Draw).
3. Grep for `TextureEnabled = basic.Texture != null` or `TextureEnabled = (basic.Texture != null)` in EnsureSkinnedEffects to confirm the conditional pattern.
  </verify>
  <done>
SkinnedEffect.TextureEnabled is set to true when a Texture is present in both EnsureSkinnedEffects (load-time replacement) and the Draw loop. Models with textures will render with surface detail instead of flat gray. Game compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/Berzerk.csproj` compiles with zero errors
2. `TextureEnabled` appears in AnimatedModel.cs in both EnsureSkinnedEffects and Draw methods
3. TextureEnabled is conditional on Texture being non-null (not blindly set to true)
4. No other methods or files are modified
</verification>

<success_criteria>
- SkinnedEffect.TextureEnabled is set to true when Texture is assigned in EnsureSkinnedEffects
- SkinnedEffect.TextureEnabled is set to true in the Draw loop for defensive correctness
- Game compiles without errors
- Visual result: models render with texture detail instead of flat dark gray (verified in human testing)
</success_criteria>

<output>
After completion, create `.planning/phases/04-rendering-and-game-integration/04-03-SUMMARY.md`
</output>
