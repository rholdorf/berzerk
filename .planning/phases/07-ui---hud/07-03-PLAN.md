---
phase: 07-ui-hud
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - Berzerk/BerzerkGame.cs
  - Berzerk/Source/UI/GameOverScreen.cs
  - Berzerk/Source/UI/HealthBar.cs
  - Berzerk/Source/Enemies/EnemyManager.cs
autonomous: false

must_haves:
  truths:
    - "Game starts in MainMenu state showing start menu, not gameplay"
    - "Pressing Start Game transitions to Playing state"
    - "ESC during gameplay opens pause menu, ESC again resumes"
    - "Score increases by 50 points when each enemy is destroyed"
    - "Ammo counter shows magazine/reserve and flashes when low"
    - "Score counter shows current points at top-center"
    - "Pickup notifications appear briefly when collecting ammo or health"
    - "Game over screen shows final score with Restart and Quit buttons"
    - "Health bar flashes red when player takes damage"
    - "All HUD elements visible during gameplay (health, ammo, score, crosshair)"
  artifacts:
    - path: "Berzerk/BerzerkGame.cs"
      provides: "Complete game state machine with MainMenu, Playing, Paused, Dying, GameOver states and all UI wiring"
    - path: "Berzerk/Source/UI/GameOverScreen.cs"
      provides: "Enhanced game over with final score display and Restart/Quit buttons"
    - path: "Berzerk/Source/UI/HealthBar.cs"
      provides: "Health bar with damage flash effect"
    - path: "Berzerk/Source/Enemies/EnemyManager.cs"
      provides: "Public OnEnemyKilled event for score tracking"
  key_links:
    - from: "BerzerkGame.cs"
      to: "ScoreSystem"
      via: "EnemyManager death event -> ScoreSystem.AddEnemyKill"
      pattern: "_scoreSystem\\.AddEnemyKill"
    - from: "BerzerkGame.cs"
      to: "StartMenu"
      via: "OnStartGame event -> GameState.Playing"
      pattern: "_startMenu\\.OnStartGame"
    - from: "BerzerkGame.cs"
      to: "PauseMenu"
      via: "OnResume event -> GameState.Playing, ESC toggles pause"
      pattern: "_pauseMenu\\.(OnResume|OnQuit)"
    - from: "BerzerkGame.cs"
      to: "GameOverScreen"
      via: "OnRestart -> RestartGame, OnQuit -> Exit, Draw with score"
      pattern: "_gameOverScreen\\.Draw.*_scoreSystem"
    - from: "BerzerkGame.cs"
      to: "PickupNotification"
      via: "Before/after ammo/health comparison in UpdatePlaying"
      pattern: "_pickupNotification\\.Show"
---

<objective>
Integrate all UI elements into BerzerkGame, enhance GameOverScreen with score and buttons, add health bar flash, wire score tracking to enemy deaths, and implement complete game state machine with MainMenu and Paused states.

Purpose: This is the integration plan that wires Plans 01 and 02 into the game loop. It adds MainMenu and Paused to the GameState enum, connects ScoreSystem to enemy deaths via EnemyManager, wires pickup notifications, enhances GameOverScreen with final score + interactive buttons, adds damage flash to HealthBar, and establishes the complete UI draw order. After this plan, all Phase 7 success criteria are met.

Output: Modified BerzerkGame.cs with complete state machine and UI integration, enhanced GameOverScreen.cs with score + buttons, enhanced HealthBar.cs with flash, EnemyManager.cs with public death event.
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ui---hud/07-CONTEXT.md
@.planning/phases/07-ui---hud/07-RESEARCH.md

# Prior plan outputs (must exist before this plan runs):
@.planning/phases/07-ui---hud/07-01-SUMMARY.md
@.planning/phases/07-ui---hud/07-02-SUMMARY.md

# Files to modify:
@Berzerk/BerzerkGame.cs
@Berzerk/Source/UI/GameOverScreen.cs
@Berzerk/Source/UI/HealthBar.cs
@Berzerk/Source/Enemies/EnemyManager.cs
@Berzerk/Source/Input/InputManager.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EnemyManager death event, enhance HealthBar and GameOverScreen</name>
  <files>
    Berzerk/Source/Enemies/EnemyManager.cs
    Berzerk/Source/UI/HealthBar.cs
    Berzerk/Source/UI/GameOverScreen.cs
  </files>
  <action>
**EnemyManager.cs** — Add public event for individual enemy deaths (currently only OnAllEnemiesDefeated exists):
- Add field: `public event Action? OnEnemyKilled;`
- In existing `OnEnemyDeath(EnemyController enemy)` method, fire `OnEnemyKilled?.Invoke();` at the start (before explosion/drop logic). This gives BerzerkGame a hookpoint to increment score per kill.

**HealthBar.cs** — Add damage flash effect per CONTEXT "Red vignette flash + health bar flash":
- Add fields: `private bool _isFlashing`, `private float _flashAlpha`, `private const float FlashDuration = 0.4f`
- Add method: `public void Trigger()` — sets `_isFlashing = true`, `_flashAlpha = 1.0f` (same naming pattern as DamageVignette.Trigger)
- Add method: `public void Update(float deltaTime)` — if flashing, apply exponential decay: `_flashAlpha *= (float)Math.Pow(0.01, deltaTime / FlashDuration)`. When `_flashAlpha < 0.01f`, set to 0 and `_isFlashing = false`.
- Modify Draw: when `_isFlashing && _flashAlpha > 0`, draw an additional red overlay rectangle over the health bar fill area using `Color.Red * _flashAlpha`. This creates a flash-on-damage effect coordinated with DamageVignette.
- Add `using System;` for Math.Pow.

**GameOverScreen.cs** — Enhance with final score display and interactive buttons per CONTEXT:
- Add fields: `Rectangle _restartButton`, `Rectangle _quitButton`, `bool _isHoveringRestart`, `bool _isHoveringQuit`
- Add events: `event Action? OnRestart`, `event Action? OnQuit`
- Add method: `public void Update(MouseState currentMouse, MouseState previousMouse)`:
  - Check hover state on both buttons using Rectangle.Contains
  - Detect click (released after pressed), fire OnRestart or OnQuit
- Modify Draw signature to: `Draw(SpriteBatch spriteBatch, Viewport viewport, int finalScore)`
  - Draw black background (existing)
  - Draw "GAME OVER" in Color.Red, centered, at viewport.Height / 2f - 120 (existing message split)
  - Draw "Final Score: {finalScore}" in Color.White, centered, at viewport.Height / 2f - 50
  - Draw "Restart" button centered at viewport.Height / 2f + 30
  - Draw "Quit" button centered at viewport.Height / 2f + 100
  - Button style: gray background (darker on hover), white text, 40px/20px padding
  - Remove the old `_message` field and simple text draw — replace with the structured layout above
- Add `using Microsoft.Xna.Framework.Input;` for MouseState
- Add private helper `DrawButton(SpriteBatch, string text, float centerY, bool isHovering, out Rectangle bounds, Viewport viewport)` (same pattern as PauseMenu)
  </action>
  <verify>
Run `dotnet build Berzerk/Berzerk.csproj` — must compile. Verify EnemyManager has OnEnemyKilled event, HealthBar has Trigger() and Update(), GameOverScreen.Draw takes finalScore parameter.
  </verify>
  <done>
EnemyManager fires OnEnemyKilled per death. HealthBar flashes red on Trigger() with exponential decay. GameOverScreen shows "GAME OVER" + final score + Restart/Quit buttons with mouse interaction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire all UI into BerzerkGame with complete state machine</name>
  <files>
    Berzerk/BerzerkGame.cs
  </files>
  <action>
This is the main integration task. Modify BerzerkGame.cs to wire all new and enhanced UI elements:

**1. Expand GameState enum:**
```csharp
public enum GameState
{
    MainMenu,   // NEW: Start screen
    Playing,    // EXISTING
    Paused,     // NEW: ESC overlay
    Dying,      // EXISTING
    GameOver    // EXISTING
}
```

**2. Add new fields in BerzerkGame class:**
```csharp
private ScoreSystem _scoreSystem;
private AmmoCounter _ammoCounter;
private ScoreCounter _scoreCounter;
private PickupNotification _pickupNotification;
private StartMenu _startMenu;
private PauseMenu _pauseMenu;
private MouseState _previousMouseState;
```
Add using statements: `using Berzerk.Source.Combat;` (if not present for ScoreSystem), no new namespace needed for UI elements (already using Berzerk.UI).

**3. Initialize in Initialize():**
- Create `_scoreSystem = new ScoreSystem();` before enemy manager setup
- Change initial `_gameState = GameState.MainMenu;` (was Playing)

**4. LoadContent additions:**
- Create and LoadContent for: `_ammoCounter`, `_scoreCounter`, `_pickupNotification`, `_startMenu`, `_pauseMenu`
- _ammoCounter.LoadContent(Content)
- _scoreCounter.LoadContent(Content)
- _pickupNotification.LoadContent(Content)
- _startMenu.LoadContent(Content, GraphicsDevice)
- _pauseMenu.LoadContent(Content, GraphicsDevice)
- Wire events:
  - `_startMenu.OnStartGame += () => { _gameState = GameState.Playing; IsMouseVisible = false; };`
  - `_pauseMenu.OnResume += () => { _gameState = GameState.Playing; _playerController.IsEnabled = true; IsMouseVisible = false; };`
  - `_pauseMenu.OnQuit += Exit;`
  - `_gameOverScreen.OnRestart += () => { RestartGame(); IsMouseVisible = false; };`
  - `_gameOverScreen.OnQuit += Exit;`
  - `_enemyManager.OnEnemyKilled += _scoreSystem.AddEnemyKill;`
- Wire health bar flash to damage: `_healthSystem.OnDamageTaken += () => _healthBar.Trigger();` (add alongside existing _damageVignette.Trigger wiring)
- Set IsMouseVisible = true initially (start menu needs cursor)

**5. Update() — expand switch statement:**
```
case GameState.MainMenu:
    MouseState menuMouse = Mouse.GetState();
    _startMenu.Update(menuMouse, _previousMouseState);
    _previousMouseState = menuMouse;
    break;

case GameState.Playing:
    // Add ESC pause check BEFORE existing UpdatePlaying call:
    if (_inputManager.IsKeyPressed(Keys.Escape))
    {
        _gameState = GameState.Paused;
        _playerController.IsEnabled = false;
        IsMouseVisible = true;  // Show cursor for pause menu buttons
        break;
    }
    UpdatePlaying(gameTime, deltaTime);
    break;

case GameState.Paused:
    // ESC to unpause
    if (_inputManager.IsKeyPressed(Keys.Escape))
    {
        _gameState = GameState.Playing;
        _playerController.IsEnabled = true;
        IsMouseVisible = false;
    }
    MouseState pauseMouse = Mouse.GetState();
    _pauseMenu.Update(pauseMouse, _previousMouseState);
    _previousMouseState = pauseMouse;
    break;

case GameState.Dying:
    UpdateDying(deltaTime);
    break;

case GameState.GameOver:
    IsMouseVisible = true;  // Show cursor for game over buttons
    MouseState goMouse = Mouse.GetState();
    _gameOverScreen.Update(goMouse, _previousMouseState);
    _previousMouseState = goMouse;
    break;
```
Remove the `_inputManager.IsKeyPressed(Keys.Escape) -> Exit()` from UpdatePlaying (ESC now pauses instead of exits). Remove `_inputManager.IsKeyPressed(Keys.Escape) -> Exit()` from UpdateGameOver (handled by button now). Remove `_inputManager.IsKeyPressed(Keys.R) -> RestartGame()` from UpdateGameOver (handled by button now).

**6. UpdatePlaying modifications:**
- Add `_healthBar.Update(deltaTime);` alongside `_damageVignette.Update(deltaTime);`
- Add `_pickupNotification.Update(deltaTime);` alongside other updates
- Add `_ammoCounter.Update(deltaTime);` for flash timing
- Add pickup notification detection around existing `_targetManager.CheckPickupCollection`:
  ```csharp
  int ammoBefore = _ammoSystem.TotalAmmo;
  int healthBefore = _healthSystem.CurrentHealth;
  _targetManager.CheckPickupCollection(_playerController.Transform.Position, _ammoSystem, _healthSystem);
  int ammoGained = _ammoSystem.TotalAmmo - ammoBefore;
  if (ammoGained > 0)
      _pickupNotification.Show($"+{ammoGained} Ammo", GraphicsDevice.Viewport);
  int healthGained = _healthSystem.CurrentHealth - healthBefore;
  if (healthGained > 0)
      _pickupNotification.Show($"+{healthGained} Health", GraphicsDevice.Viewport);
  ```

**7. Draw() — expand UI section:**
Replace the 2D UI block with:
```csharp
_spriteBatch.Begin();

if (_gameState == GameState.MainMenu)
{
    _startMenu.Draw(_spriteBatch, GraphicsDevice.Viewport);
}
else if (_gameState == GameState.Playing || _gameState == GameState.Paused)
{
    // HUD elements (visible during gameplay and when paused)
    _crosshair.Draw(_spriteBatch, GraphicsDevice.Viewport);
    _healthBar.Draw(_spriteBatch, _healthSystem.CurrentHealth, _healthSystem.MaxHealth);
    _ammoCounter.Draw(_spriteBatch, _ammoSystem.CurrentMagazine, _ammoSystem.ReserveAmmo, GraphicsDevice.Viewport);
    _scoreCounter.Draw(_spriteBatch, _scoreSystem.CurrentScore, GraphicsDevice.Viewport);
    _pickupNotification.Draw(_spriteBatch);

    // Pause overlay on top of HUD
    if (_gameState == GameState.Paused)
    {
        _pauseMenu.Draw(_spriteBatch, GraphicsDevice.Viewport);
    }
}

// Effects (always, they handle own alpha)
_damageVignette.Draw(_spriteBatch, GraphicsDevice.Viewport);
_screenFade.Draw(_spriteBatch, GraphicsDevice.Viewport);

// Game over screen (on top of everything)
if (_gameState == GameState.GameOver)
{
    _gameOverScreen.Draw(_spriteBatch, GraphicsDevice.Viewport, _scoreSystem.CurrentScore);
}

_spriteBatch.End();
```

**8. RestartGame() — add score reset:**
- Add `_scoreSystem.Reset();` alongside other resets
- Set `_gameState = GameState.Playing;` (already exists)

**9. HandleRoomTransition — no changes needed** (score tracks through enemy kills, not room transitions)

**Key details:**
- Mouse visibility toggles: visible in MainMenu, hidden in Playing, visible in Paused, visible in GameOver
- Previous mouse state tracking: store `_previousMouseState` for menu click detection
- ESC key: pauses/unpauses during Playing/Paused, does NOT exit game anymore. Exiting is only through Quit buttons.
- The `IsMouseVisible = true` line should be added in Initialize() or constructor since game starts in MainMenu state. Change existing `IsMouseVisible = false;` in constructor to `IsMouseVisible = true;`
  </action>
  <verify>
Run `dotnet build Berzerk/Berzerk.csproj` — must compile with no errors. Verify:
1. GameState enum has 5 values (MainMenu, Playing, Paused, Dying, GameOver)
2. Update switch handles all 5 states
3. Draw section has proper state-conditional rendering
4. ScoreSystem wired to EnemyManager.OnEnemyKilled
5. PickupNotification wired to before/after pickup comparison
6. HealthBar.Trigger wired to OnDamageTaken
  </verify>
  <done>
BerzerkGame has complete 5-state game loop. Start menu shows first, transitions to gameplay. ESC pauses/unpauses. Score tracks enemy kills. Ammo/score/pickups display in HUD. Game over shows final score with buttons. Health bar flashes on damage.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 7 UI & HUD integration: start menu, pause menu, HUD elements (health bar, ammo counter, score counter, crosshair), pickup notifications, enhanced game over screen with score and buttons, health bar damage flash, and score tracking.</what-built>
  <how-to-verify>
1. Launch game: `dotnet run --project Berzerk/Berzerk.csproj`
2. **Start menu**: Game should open showing "BERZERK" title and "Start Game" button on black background. Mouse cursor should be visible. Hover over button — should darken. Click to start.
3. **HUD during gameplay**: Verify visible elements:
   - Crosshair at screen center
   - Health bar at top-left (existing but now with flash)
   - Ammo counter at top-right showing "25 / 125" format
   - Score counter at top-center showing "Score: 0"
4. **Kill enemies**: Shoot robots. Score should increment by 50 per kill ("Score: 50", "Score: 100", etc.)
5. **Collect pickups**: When enemies drop ammo/health pickups, collect them. Brief "+X Ammo" or "+X Health" text should appear center-screen and fade away after ~2 seconds.
6. **Low ammo**: Fire repeatedly until magazine is below 10. Ammo counter should flash/pulse red.
7. **Health bar flash**: Press H (test damage key). Health bar should briefly flash red (coordinated with red vignette).
8. **Pause menu**: Press ESC during gameplay. Game should freeze, semi-transparent dark overlay appears with "PAUSED" title, "Resume" and "Quit" buttons. Mouse cursor becomes visible. Click Resume to continue (cursor hides, gameplay resumes). Press ESC again to unpause.
9. **Game over**: Take enough damage to die (press H repeatedly). After death fade, game over screen shows "GAME OVER", final score, "Restart" and "Quit" buttons. Click Restart to play again (score resets to 0). Click Quit to exit.
10. **Score persistence**: Score should carry across rooms (kill enemies, transition through door, score stays).
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `dotnet build Berzerk/Berzerk.csproj` passes with no errors
2. Game launches to MainMenu state (not directly into gameplay)
3. All 6 requirements met:
   - UI-01: Crosshair at screen center (existing, still works)
   - UI-02: Health bar displays HP with damage flash (enhanced)
   - UI-03: Ammo counter at top-right with low ammo flash (new)
   - UI-04: Score counter at top-center, increments on kills (new)
   - UI-05: Game over shows final score (enhanced)
   - UI-06: Start menu with Start Game button (new)
4. Additional CONTEXT features: pause menu (ESC), pickup notifications, health bar flash
5. All HUD elements always visible during gameplay (no fading/hiding)
6. Monochrome white/gray aesthetic per CONTEXT decisions
</verification>

<success_criteria>
- GameState enum expanded to 5 states with proper transitions
- ScoreSystem wired to EnemyManager.OnEnemyKilled
- All HUD elements rendering in correct positions
- Menus interactive with mouse buttons
- Pickup notifications appear and fade
- Health bar flashes on damage
- Game over screen shows final score
- ESC pauses/unpauses (no longer exits)
- Game starts in MainMenu state
</success_criteria>

<output>
After completion, create `.planning/phases/07-ui---hud/07-03-SUMMARY.md`
</output>
