---
phase: 02-player-movement-camera
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - Berzerk/BerzerkGame.cs
  - Berzerk/Source/UI/Crosshair.cs
autonomous: false

must_haves:
  truths:
    - "Third-person camera follows player smoothly"
    - "Scroll wheel zooms camera in/out with angle transition"
    - "Right-click drag orbits camera around player"
    - "Camera zooms in when approaching walls"
    - "Crosshair displays at screen center"
    - "OS cursor is hidden during gameplay"
  artifacts:
    - path: "Berzerk/BerzerkGame.cs"
      provides: "Integrated player movement and camera system"
      contains: "ThirdPersonCamera"
    - path: "Berzerk/Source/UI/Crosshair.cs"
      provides: "Crosshair sprite rendering"
      min_lines: 30
  key_links:
    - from: "BerzerkGame"
      to: "PlayerController"
      via: "Update and Draw calls"
      pattern: "_playerController\\.Update"
    - from: "BerzerkGame"
      to: "ThirdPersonCamera"
      via: "Update and ViewMatrix/ProjectionMatrix usage"
      pattern: "_camera\\.ViewMatrix"
---

<objective>
Integrate PlayerController and ThirdPersonCamera into BerzerkGame, add crosshair UI, and verify all Phase 2 requirements with human checkpoint.

Purpose: Complete Phase 2 integration and validation - final wiring of all systems
Output: Fully integrated player movement and camera with crosshair, verified by user
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-player-movement-camera/02-CONTEXT.md
@.planning/phases/02-player-movement-camera/02-RESEARCH.md
@.planning/phases/02-player-movement-camera/02-01-SUMMARY.md
@.planning/phases/02-player-movement-camera/02-02-SUMMARY.md
@.planning/phases/02-player-movement-camera/02-03-SUMMARY.md

# Source files
@Berzerk/BerzerkGame.cs
@Berzerk/Source/Controllers/PlayerController.cs
@Berzerk/Source/Graphics/ThirdPersonCamera.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Crosshair UI component</name>
  <files>Berzerk/Source/UI/Crosshair.cs</files>
  <action>
Create new directory `Berzerk/Source/UI/` and Crosshair.cs:

```csharp
namespace Berzerk.UI;

/// <summary>
/// Simple crosshair rendered at screen center.
/// Creates texture programmatically (no external asset needed).
/// </summary>
public class Crosshair
{
    private Texture2D _texture;
    private Vector2 _origin;
    private const int Size = 24;      // Crosshair size in pixels
    private const int Thickness = 2;  // Line thickness
    private const int Gap = 4;        // Gap in center

    public void LoadContent(GraphicsDevice graphicsDevice)
    {
        // Create crosshair texture programmatically
        _texture = new Texture2D(graphicsDevice, Size, Size);
        Color[] pixels = new Color[Size * Size];

        int center = Size / 2;

        for (int y = 0; y < Size; y++)
        {
            for (int x = 0; x < Size; x++)
            {
                int dx = Math.Abs(x - center);
                int dy = Math.Abs(y - center);

                bool isHorizontalLine = dy < Thickness && dx >= Gap && dx < Size / 2;
                bool isVerticalLine = dx < Thickness && dy >= Gap && dy < Size / 2;

                if (isHorizontalLine || isVerticalLine)
                {
                    pixels[y * Size + x] = Color.White;
                }
                else
                {
                    pixels[y * Size + x] = Color.Transparent;
                }
            }
        }

        _texture.SetData(pixels);
        _origin = new Vector2(Size / 2f, Size / 2f);
    }

    public void Draw(SpriteBatch spriteBatch, Viewport viewport)
    {
        Vector2 screenCenter = new Vector2(viewport.Width / 2f, viewport.Height / 2f);
        spriteBatch.Draw(_texture, screenCenter, null, Color.LimeGreen, 0f, _origin, 1f, SpriteEffects.None, 0f);
    }
}
```

Include usings: Microsoft.Xna.Framework, Microsoft.Xna.Framework.Graphics, System
  </action>
  <verify>
Build succeeds: `dotnet build Berzerk/Berzerk.csproj`
Crosshair.cs exists in Berzerk/Source/UI/
  </verify>
  <done>
Crosshair component creates texture programmatically and renders at screen center
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all systems into BerzerkGame</name>
  <files>Berzerk/BerzerkGame.cs</files>
  <action>
Update BerzerkGame.cs to integrate ThirdPersonCamera and Crosshair:

**1. Add new fields:**
```csharp
private ThirdPersonCamera _camera;
private Crosshair _crosshair;
private List<BoundingBox> _testWalls;
```

**2. In Initialize():**
```csharp
// After _inputManager and _playerController creation:
_camera = new ThirdPersonCamera(_inputManager, _playerController.Transform);
_crosshair = new Crosshair();

// Hide OS cursor (we draw our own crosshair)
IsMouseVisible = false;
```

**3. In LoadContent():**
```csharp
// After other LoadContent:
_camera.Initialize(GraphicsDevice);
_crosshair.LoadContent(GraphicsDevice);

// Set up test collision walls
_testWalls = ThirdPersonCamera.CreateTestWalls();
_camera.SetCollisionGeometry(_testWalls);
```

**4. In Update():**
```csharp
// After _playerController.Update(gameTime):
_camera.Update(gameTime);
```

**5. In Draw():**
Replace the old camera matrix usage:
```csharp
// Draw 3D content with camera matrices
_currentModel?.Draw(
    _playerController.Transform.WorldMatrix,
    _camera.ViewMatrix,
    _camera.ProjectionMatrix
);

// Optional: Draw test walls as wireframe or simple boxes for debugging
// (Can be removed after testing)

// Draw 2D UI (crosshair)
_spriteBatch.Begin();
_crosshair.Draw(_spriteBatch, GraphicsDevice.Viewport);
_spriteBatch.End();
```

**6. Remove old camera matrix fields (_viewMatrix, _projectionMatrix)** - they're now in ThirdPersonCamera.

**7. Add usings:**
```csharp
using Berzerk.Graphics;
using Berzerk.UI;
using System.Collections.Generic;
```

**8. Update console output in LoadContent:**
```csharp
Console.WriteLine("\n=== Controls ===");
Console.WriteLine("WASD: Move player");
Console.WriteLine("Mouse: Aim (crosshair)");
Console.WriteLine("Right-click + drag: Orbit camera");
Console.WriteLine("Scroll wheel: Zoom camera");
Console.WriteLine("1/2/3: Switch animations");
Console.WriteLine("Escape: Exit");
Console.WriteLine("================\n");
```
  </action>
  <verify>
Build succeeds: `dotnet build Berzerk/Berzerk.csproj`
Run game: `dotnet run --project Berzerk/Berzerk.csproj`
Test movement and camera controls work
  </verify>
  <done>
All Phase 2 systems integrated: player movement, third-person camera, crosshair UI
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 player movement and camera system:
- WASD player movement with snappy acceleration
- Player rotation toward movement direction
- Third-person camera with smooth following
- Scroll wheel camera zoom with angle transition
- Right-click drag camera orbit
- Camera collision detection (zooms in near walls)
- Crosshair at screen center (OS cursor hidden)
  </what-built>
  <how-to-verify>
Run the game: `dotnet run --project Berzerk/Berzerk.csproj`

Test each requirement:

1. **Movement (MOVE-01):**
   - Press WASD keys, player should move in 3D space
   - Movement should feel snappy (quick acceleration)
   - Diagonal movement should not be faster than cardinal

2. **Rotation:**
   - When moving, player character should rotate to face movement direction
   - Rotation should blend smoothly, not snap instantly

3. **Camera Following (MOVE-03):**
   - Camera should follow player smoothly with light spring feel
   - No jitter or sudden jumps

4. **Camera Zoom (MOVE-05):**
   - Scroll wheel UP = camera moves closer
   - Scroll wheel DOWN = camera moves farther
   - Camera angle should be more eye-level when close, more top-down when far

5. **Camera Orbit:**
   - Hold right mouse button and drag to orbit camera around player
   - Release right button to stop orbiting

6. **Camera Collision (MOVE-04):**
   - Move player near test walls (edges of play area or center pillar)
   - Camera should automatically zoom in to avoid clipping through walls
   - Camera should smoothly zoom back out when moving away from walls

7. **Crosshair:**
   - Green crosshair visible at screen center
   - OS mouse cursor should be hidden

8. **Animation (still works):**
   - Press 1, 2, 3 to switch idle/walk/run animations
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks (including checkpoint approval):
1. All Phase 2 success criteria from ROADMAP.md met:
   - Player moves in 3D space using WASD
   - Player rotates toward movement direction (face direction, not cursor)
   - Camera follows smoothly with spring interpolation
   - Camera collision detection active
   - Camera distance and angle adjustable
2. User has verified feel of movement and camera
</verification>

<success_criteria>
- MOVE-01: WASD movement working
- MOVE-02: Player rotation toward movement direction (partial - cursor direction is Phase 3 aiming)
- MOVE-03: Smooth camera following
- MOVE-04: Camera collision detection
- MOVE-05: Camera zoom/angle adjustment
- All systems integrated without conflicts
- User approval of feel and responsiveness
</success_criteria>

<output>
After completion, create `.planning/phases/02-player-movement-camera/02-04-SUMMARY.md`
</output>
