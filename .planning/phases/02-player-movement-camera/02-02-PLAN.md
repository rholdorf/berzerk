---
phase: 02-player-movement-camera
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Berzerk/Source/Controllers/PlayerController.cs
  - Berzerk/BerzerkGame.cs
autonomous: true

must_haves:
  truths:
    - "Player moves in 3D space using WASD keys"
    - "Movement is frame-rate independent (uses deltaTime)"
    - "Player character rotates to face movement direction"
    - "Movement feels snappy with quick acceleration"
  artifacts:
    - path: "Berzerk/Source/Controllers/PlayerController.cs"
      provides: "WASD movement with rotation"
      min_lines: 60
      contains: "IsKeyHeld"
    - path: "Berzerk/BerzerkGame.cs"
      provides: "PlayerController integration"
      contains: "PlayerController"
  key_links:
    - from: "PlayerController"
      to: "InputManager"
      via: "IsKeyHeld for WASD"
      pattern: "_inputManager\\.IsKeyHeld"
    - from: "PlayerController"
      to: "Transform"
      via: "Position and Rotation updates"
      pattern: "Transform\\.Position"
---

<objective>
Implement PlayerController with WASD movement and rotation toward movement direction.

Purpose: Core player movement for the game - MOVE-01 and partial MOVE-02
Output: PlayerController.cs with movement logic, integrated into BerzerkGame
</objective>

<execution_context>
@/Users/rui/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rui/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-player-movement-camera/02-CONTEXT.md
@.planning/phases/02-player-movement-camera/02-RESEARCH.md
@.planning/phases/02-player-movement-camera/02-01-SUMMARY.md

# Source files
@Berzerk/Source/Input/InputManager.cs
@Berzerk/Source/Core/Transform.cs
@Berzerk/BerzerkGame.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PlayerController with WASD movement</name>
  <files>Berzerk/Source/Controllers/PlayerController.cs</files>
  <action>
Create new directory `Berzerk/Source/Controllers/` and PlayerController.cs:

**Key implementation details from CONTEXT.md:**
- Snappy acceleration (quick ramp to full speed, not instant)
- Player faces movement direction (not cursor)
- Quick rotation blend when changing direction

**Movement implementation:**

```csharp
namespace Berzerk.Controllers;

public class PlayerController
{
    public Transform Transform { get; }

    // Movement settings
    private const float MoveSpeed = 5f;        // Units per second
    private const float Acceleration = 20f;    // How fast to reach full speed
    private const float Deceleration = 15f;    // How fast to stop
    private const float RotationSpeed = 10f;   // Radians per second for rotation blend

    private Vector3 _velocity = Vector3.Zero;
    private InputManager _inputManager;

    public PlayerController(InputManager inputManager)
    {
        Transform = new Transform();
        _inputManager = inputManager;
    }

    public void Update(GameTime gameTime)
    {
        float deltaTime = (float)gameTime.ElapsedGameTime.TotalSeconds;

        // 1. Gather input direction (WASD)
        Vector3 inputDir = GetInputDirection();

        // 2. Calculate target velocity
        Vector3 targetVelocity = inputDir * MoveSpeed;

        // 3. Apply snappy acceleration/deceleration
        float accel = inputDir.LengthSquared() > 0 ? Acceleration : Deceleration;
        _velocity = Vector3.Lerp(_velocity, targetVelocity, accel * deltaTime);

        // 4. Apply velocity to position
        Transform.Position += _velocity * deltaTime;

        // 5. Rotate toward movement direction (only if moving)
        if (_velocity.LengthSquared() > 0.01f)
        {
            RotateToward(_velocity, deltaTime);
        }
    }

    private Vector3 GetInputDirection()
    {
        Vector3 dir = Vector3.Zero;

        if (_inputManager.IsKeyHeld(Keys.W)) dir += Vector3.Forward;  // -Z in MonoGame
        if (_inputManager.IsKeyHeld(Keys.S)) dir += Vector3.Backward; // +Z
        if (_inputManager.IsKeyHeld(Keys.A)) dir += Vector3.Left;     // -X
        if (_inputManager.IsKeyHeld(Keys.D)) dir += Vector3.Right;    // +X

        // Normalize to prevent faster diagonal movement
        if (dir.LengthSquared() > 0)
            dir = Vector3.Normalize(dir);

        return dir;
    }

    private void RotateToward(Vector3 direction, float deltaTime)
    {
        // Calculate target rotation from direction
        direction.Y = 0; // Keep rotation on Y axis only
        if (direction.LengthSquared() < 0.001f) return;

        direction = Vector3.Normalize(direction);

        // Create target rotation looking in movement direction
        Quaternion targetRotation = Quaternion.CreateFromRotationMatrix(
            Matrix.CreateWorld(Vector3.Zero, direction, Vector3.Up)
        );

        // Slerp for smooth rotation blend
        float smoothFactor = 1f - MathF.Pow(0.001f, RotationSpeed * deltaTime);
        Transform.Rotation = Quaternion.Slerp(Transform.Rotation, targetRotation, smoothFactor);
    }
}
```

Include required usings: Microsoft.Xna.Framework, Microsoft.Xna.Framework.Input, Berzerk.Core, Berzerk.Source.Input, System
  </action>
  <verify>
Build succeeds: `dotnet build Berzerk/Berzerk.csproj`
PlayerController.cs exists with Update, GetInputDirection, RotateToward methods
  </verify>
  <done>
PlayerController handles WASD movement with snappy acceleration and smooth rotation toward movement direction
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PlayerController into BerzerkGame</name>
  <files>Berzerk/BerzerkGame.cs</files>
  <action>
Modify BerzerkGame.cs to use PlayerController:

1. **Add field:**
   ```csharp
   private PlayerController _playerController;
   ```

2. **In Initialize() after InputManager creation:**
   ```csharp
   _playerController = new PlayerController(_inputManager);
   ```

3. **In Update() after InputManager.Update():**
   ```csharp
   _playerController.Update(gameTime);
   ```

4. **In Draw() - update the model drawing to use player transform:**
   - Get world matrix from `_playerController.Transform.WorldMatrix`
   - Pass to AnimatedModel.Draw instead of Matrix.Identity

5. **Update camera to follow player (temporary, will be replaced by ThirdPersonCamera):**
   - Update _viewMatrix based on player position
   - For now: camera looks at player position from behind

   ```csharp
   // Temporary: Update camera to follow player
   Vector3 cameraOffset = new Vector3(0, 100, 200);
   Vector3 cameraPos = _playerController.Transform.Position + cameraOffset;
   _viewMatrix = Matrix.CreateLookAt(
       cameraPos,
       _playerController.Transform.Position + new Vector3(0, 50, 0),
       Vector3.Up
   );
   ```

Add using: `using Berzerk.Controllers;`

Keep animation switching (keys 1,2,3) for testing - player can still switch animations while moving.
  </action>
  <verify>
Build succeeds: `dotnet build Berzerk/Berzerk.csproj`
Run game: `dotnet run --project Berzerk/Berzerk.csproj`
Test: WASD keys should move the character model, camera should follow
  </verify>
  <done>
Player character moves with WASD controls, model renders at player position, camera follows player
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `dotnet build Berzerk/Berzerk.csproj` succeeds
2. `dotnet run --project Berzerk/Berzerk.csproj` launches game
3. WASD keys move player in 3D space
4. Movement feels snappy (quick acceleration to full speed)
5. Character rotates to face movement direction
6. Camera follows player (basic, not final camera system)
7. Animation switching still works (keys 1,2,3)
</verification>

<success_criteria>
- WASD movement working with frame-rate independent physics
- Player rotation toward movement direction with smooth blend
- Character model moves with player
- Camera follows player (temporary implementation)
- No visual jitter or stutter during movement
</success_criteria>

<output>
After completion, create `.planning/phases/02-player-movement-camera/02-02-SUMMARY.md`
</output>
